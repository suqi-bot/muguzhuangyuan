import{d as Z,u as ss,N as ts,a as as,b as T,c as C,o as es,e as os,f as n,g as l,h as D,j as y,i as t,A as is,l as r,O as P,t as i,F as b,k as N,x,p,s as m,w as O,_ as ns}from"./index-DFO3eZqt.js";import{useCartStore as ls}from"./cart-DfVsmXqk.js";import{r as V}from"./request-DzKJqaQU.js";import{p as cs}from"./ProductAIService-DSYmRkHQ.js";import{A as ds}from"./aos-DHpK1uqy.js";const rs={class:"orders-page"},us={class:"orders-main"},ps={class:"orders-container"},vs={class:"page-header","data-aos":"fade-down","data-aos-duration":"800"},ms={key:0,class:"stats-preview"},fs={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"200"},gs={class:"stat-number"},_s={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"400"},hs={class:"stat-number"},ys={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"600"},bs={class:"stat-number"},ks={class:"order-filters","data-aos":"fade-up","data-aos-delay":"300"},ws={class:"filters-container"},As=["onClick","data-aos-delay"],Cs={class:"filter-icon"},Ds={class:"filter-text"},Ns={key:0,class:"count"},Os={class:"orders-section"},Is={key:0,class:"login-prompt","data-aos":"fade-up"},Ss={class:"prompt-actions"},Ms={key:0,class:"loading","data-aos":"fade-in"},Ts={key:1,class:"no-orders","data-aos":"fade-up"},xs={key:2,class:"orders-list"},js=["data-aos-delay","onClick"],$s={class:"order-header"},qs={class:"order-info"},Ps={class:"order-number-section"},Vs={class:"order-icon"},zs={class:"order-details"},Bs={class:"order-number"},Fs={class:"order-meta"},Es={class:"order-date"},Ls={class:"order-status-container"},Rs={class:"status-icon"},Us={class:"status-text"},Js={key:0,class:"status-pulse"},Gs={class:"order-content"},Hs={key:0,class:"room-info"},Ks={class:"room-image-container"},Qs=["src","alt"],Ws={class:"room-details"},Xs={class:"room-header"},Ys={class:"room-name"},Zs={class:"room-type"},st={class:"stay-info"},tt={class:"stay-item"},at={class:"stay-details"},et={class:"stay-value"},ot={class:"stay-item"},it={class:"stay-details"},nt={class:"stay-value"},lt={class:"nights-badge"},ct={key:1,class:"product-info"},dt=["src","alt"],rt={class:"product-details"},ut={class:"product-name"},pt={class:"product-desc"},vt={key:0,class:"product-specs"},mt={class:"product-quantity"},ft={class:"product-price"},gt={class:"current-price"},_t={class:"shipping-info"},ht={class:"info-item"},yt={class:"value"},bt={class:"info-item"},kt={class:"value"},wt={class:"order-price"},At={class:"price-container"},Ct={class:"price-breakdown"},Dt={class:"price-item"},Nt={class:"price-calculation"},Ot={class:"price-item total"},It={class:"total-amount"},St={class:"amount"},Mt={class:"order-actions"},Tt={class:"actions-container"},xt=["onClick"],jt=["onClick"],$t=["onClick"],qt=["onClick"],Pt=Z({__name:"OrdersView",setup(Vt){const u=ss(),k=ts(),v=as(),f=ls(),I=T(!1),g=T([]),_=T("all"),z={201:"/src/assets/images/field-research/room-visits/room-visit1.jpg",202:"/src/assets/images/field-research/room-visits/room-visit1.jpg",301:"/src/assets/images/field-research/room-visits/room-visit2.jpg",302:"/src/assets/images/field-research/room-visits/room-visit2.jpg",401:"/src/assets/images/field-research/indoor-research/indoor3.jpg",402:"/src/assets/images/field-research/indoor-research/indoor3.jpg",501:"/src/assets/images/field-research/indoor-research/indoor5.jpg",502:"/src/assets/images/field-research/indoor-research/indoor5.jpg",601:"/src/assets/images/field-research/indoor-research/indoor7.jpg",602:"/src/assets/images/field-research/indoor-research/indoor7.jpg"},B={201:"蘑菇森林小屋",202:"蘑菇森林小屋",301:"蘑菇生态园",302:"蘑菇生态园",401:"茶文化体验馆",402:"茶文化体验馆",501:"普洱茶园",502:"普洱茶园",601:"生态餐厅",602:"生态餐厅"},j=[{value:"all",label:"全部订单"},{value:"pending",label:"待确认"},{value:"confirmed",label:"已确认"},{value:"completed",label:"已完成"},{value:"cancelled",label:"已取消"}],F=a=>({待发货:"pending",已发货:"confirmed",已完成:"completed",已取消:"cancelled"})[a]||"pending",E=C(()=>f.getUserOrders().map(a=>({id:a.id,orderNo:a.id,orderNumber:a.id,status:F(a.status),originalStatus:a.status,totalAmount:a.totalAmount,createdAt:a.createdAt,createTime:a.createdAt,type:"product",items:a.items,shippingAddress:a.shippingAddress,contactPhone:a.contactPhone,remarks:a.remarks,roomName:"周边产品",roomType:"产品订单",roomImage:a.items?.[0]?.image||"/src/assets/images/周边产品/普洱茶叶1.jpg"}))),h=C(()=>[...g.value,...E.value].sort((a,s)=>{const o=new Date(a.createdAt||a.createTime).getTime();return new Date(s.createdAt||s.createTime).getTime()-o})),$=C(()=>_.value==="all"?h.value:h.value.filter(a=>a.status===_.value)),L=C(()=>{const a=j.find(s=>s.value===_.value);return a?a.label.replace("订单",""):""}),R=(a,s)=>{if(!a||!s)return 0;const o=new Date(a),d=new Date(s).getTime()-o.getTime(),c=Math.ceil(d/(1e3*60*60*24));return c>0?c:0},U=(a,s)=>a?{预订:"pending",入住:"confirmed",完成:"completed",取消:"cancelled",删除:"cancelled"}[a]||"pending":{0:"pending",1:"completed",2:"cancelled",3:"cancelled",pending:"pending",confirmed:"confirmed",completed:"completed",cancelled:"cancelled"}[s||0]||"pending",w=async()=>{I.value=!0;try{const a=await V.get("/h/order/getUserOrders");if(console.log("订单列表响应:",a),a.code===200||a.code==="200")a.data&&Array.isArray(a.data.records)?(g.value=a.data.records.map(s=>{const o=s.roomCode||s.roomName;return{id:s.id,orderNumber:s.orderNumber||`MG${s.id.toString().padStart(8,"0")}`,roomName:B[o]||s.roomName||o||"房间名称",roomType:s.roomType||"房间类型",roomImage:z[o]||s.roomImage||"/src/assets/images/实地调研/房间参观/房间参观1.jpg",checkInDate:s.startDate,checkOutDate:s.endDate,nights:s.days||R(s.startDate,s.endDate),roomPrice:s.roomPrice||s.price,totalAmount:s.total||s.amount,status:U(s.state,s.status),state:s.state,systemStatus:s.status,createTime:s.createTime,guestCount:s.amount,phone:s.phone,specialRequirements:s.userRemark}}),console.log("处理后的订单列表:",g.value)):(g.value=[],console.log("没有订单数据，设置为空数组"));else throw new Error(a.msg||"获取订单列表失败")}catch(a){if(console.error("获取订单列表失败:",a),g.value=[],a.response&&a.response.status===401)console.log("401错误，跳转到登录页"),alert("登录已过期，请重新登录"),v.logout(),u.push("/login");else if(a.response&&a.response.status===500){const s=a.response.data?.message||a.message||"";console.log("500错误，错误信息:",s),s.includes("Token无效")||s.includes("NotLoginException")?(alert("登录已过期，请重新登录"),v.logout(),u.push("/login")):alert("获取订单列表失败，请稍后重试")}else a.message&&a.message.includes("登录已过期")?(console.log("Token过期错误，跳转到登录页"),v.logout(),u.push("/login")):(console.log("其他错误:",a.message),alert("获取订单列表失败，请稍后重试"))}finally{I.value=!1}},A=a=>a==="all"?h.value.length:h.value.filter(s=>s.status===a).length,J=a=>({pending:"待确认",confirmed:"已确认",completed:"已完成",cancelled:"已取消"})[a]||a,G=a=>({pending:"fas fa-clock",confirmed:"fas fa-check-circle",completed:"fas fa-star",cancelled:"fas fa-times-circle"})[a]||"fas fa-question-circle",H=a=>({all:"fas fa-list",pending:"fas fa-clock",confirmed:"fas fa-check-circle",completed:"fas fa-star",cancelled:"fas fa-times-circle"})[a]||"fas fa-list",S=a=>new Date(a).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}),K=async a=>{if(console.log("取消订单:",a),confirm("确定要取消这个订单吗？"))try{if(a.type==="product"){const s=f.orders.findIndex(o=>o.id===a.id);if(s!==-1){f.orders[s].status="已取消",localStorage.setItem("product_orders",JSON.stringify(f.orders)),alert("订单已取消");return}}else{if(a.state!=="预订"){alert(`只有预订状态的订单才能取消，当前状态：${a.state||"未知"}`);return}console.log("取消订单请求:",a.id);const s=await V.delete(`/h/order/${a.id}`);if(console.log("取消订单响应:",s),s.code===200||s.code==="200")alert("订单已取消"),w(),window.dispatchEvent(new CustomEvent("orderCancelled",{detail:{roomId:a.roomId,orderId:a.id}}));else{const o=s.msg||s.message||"取消订单失败";alert(o),console.error("取消订单失败:",s)}}}catch(s){console.error("取消订单失败:",s);let o="取消订单失败，请稍后重试";s.response&&(s.response.status===404?o="订单不存在或已被删除":s.response.status===403?o="没有权限取消此订单":s.response.data?.msg&&(o=s.response.data.msg)),alert(o)}},M=a=>{u.push(`/order/${a.id}`)},Q=a=>{u.push(`/order/${a.id}/rate`)},W=()=>{if(k.query.action==="create"){const s=k.query.productId,o=parseInt(k.query.quantity)||1,e=k.query.items;if(s)X(s,o);else if(e)try{const d=JSON.parse(e);Y(d)}catch(d){console.error("解析购物车数据失败:",d)}}},X=async(a,s)=>{const o=cs.getProductById(a);if(!o){alert("产品不存在");return}const e={type:"product",productId:o.id,productName:o.name,quantity:s,unitPrice:o.price,totalAmount:o.price*s,status:"pending",createTime:new Date().toISOString()};try{console.log("创建产品订单:",e),alert(`成功创建订单：${o.name} x ${s}`),u.replace("/orders"),w()}catch(d){console.error("创建产品订单失败:",d),alert("创建订单失败，请稍后重试")}},Y=async a=>{const s=a.reduce((e,d)=>e+d.price*d.quantity,0),o={type:"cart",items:a,totalAmount:s,status:"pending",createTime:new Date().toISOString()};try{console.log("创建购物车订单:",o),alert(`成功创建订单，共${a.length}件商品`),u.replace("/orders"),w()}catch(e){console.error("创建购物车订单失败:",e),alert("创建订单失败，请稍后重试")}};return es(()=>{v.isAuthenticated&&(f.initializeUserData(),w()),W(),ds.init({duration:800,easing:"ease-out-cubic",once:!0,offset:50})}),(a,s)=>{const o=os("router-link");return l(),n("div",rs,[D(is),s[38]||(s[38]=y('<div class="animated-background" data-v-880058c8><div class="floating-shapes" data-v-880058c8><div class="shape shape-1" data-v-880058c8></div><div class="shape shape-2" data-v-880058c8></div><div class="shape shape-3" data-v-880058c8></div><div class="shape shape-4" data-v-880058c8></div><div class="shape shape-5" data-v-880058c8></div></div></div>',1)),t("main",us,[t("div",ps,[t("div",vs,[s[3]||(s[3]=y('<div class="header-decoration" data-v-880058c8><div class="decoration-line" data-v-880058c8></div><div class="decoration-icon" data-v-880058c8><i class="fas fa-receipt" data-v-880058c8></i></div><div class="decoration-line" data-v-880058c8></div></div><h1 class="page-title" data-v-880058c8><span class="title-text" data-v-880058c8>我的预订</span><div class="title-underline" data-v-880058c8></div></h1><p class="page-subtitle" data-v-880058c8>管理您在普洱蘑菇庄园的美好住宿体验</p>',3)),P(v).isAuthenticated?(l(),n("div",ms,[t("div",fs,[t("div",gs,i(h.value.length),1),s[0]||(s[0]=t("div",{class:"stat-label"},"总订单",-1))]),t("div",_s,[t("div",hs,i(A("completed")),1),s[1]||(s[1]=t("div",{class:"stat-label"},"已完成",-1))]),t("div",ys,[t("div",bs,i(A("pending")),1),s[2]||(s[2]=t("div",{class:"stat-label"},"待确认",-1))])])):r("",!0)]),t("div",ks,[t("div",ws,[(l(),n(b,null,N(j,(e,d)=>t("button",{key:e.value,onClick:c=>_.value=e.value,class:p(["filter-btn",{active:_.value===e.value}]),"data-aos":"fade-up","data-aos-delay":400+d*100},[t("div",Cs,[t("i",{class:p(H(e.value))},null,2)]),t("span",Ds,i(e.label),1),A(e.value)>0?(l(),n("div",Ns,i(A(e.value)),1)):r("",!0),s[4]||(s[4]=t("div",{class:"filter-ripple"},null,-1))],10,As)),64))])]),t("div",Os,[P(v).isAuthenticated?(l(),n(b,{key:1},[I.value?(l(),n("div",Ms,s[10]||(s[10]=[y('<div class="loading-animation" data-v-880058c8><div class="loading-spinner" data-v-880058c8><div class="spinner-ring" data-v-880058c8></div><div class="spinner-ring" data-v-880058c8></div><div class="spinner-ring" data-v-880058c8></div></div><div class="loading-dots" data-v-880058c8><span data-v-880058c8></span><span data-v-880058c8></span><span data-v-880058c8></span></div></div><span class="loading-text" data-v-880058c8>正在加载您的订单...</span>',2)]))):$.value.length===0?(l(),n("div",Ts,[s[12]||(s[12]=y('<div class="empty-animation" data-v-880058c8><div class="empty-icon" data-v-880058c8><i class="fas fa-calendar-times" data-v-880058c8></i><div class="empty-waves" data-v-880058c8><div class="wave" data-v-880058c8></div><div class="wave" data-v-880058c8></div><div class="wave" data-v-880058c8></div></div></div></div>',1)),t("h3",null,"暂无"+i(L.value)+"订单",1),s[13]||(s[13]=t("p",null,"开始您的普洱蘑菇庄园之旅吧",-1)),D(o,{to:"/ai-room-selection",class:"btn btn-primary btn-animated"},{default:x(()=>s[11]||(s[11]=[t("span",null,"AI智能选房",-1),t("div",{class:"btn-shine"},null,-1)])),_:1,__:[11]})])):(l(),n("div",xs,[(l(!0),n(b,null,N($.value,(e,d)=>(l(),n("div",{key:e.id,class:"order-card","data-aos":"fade-up","data-aos-delay":d*100,onClick:c=>M(e)},[s[37]||(s[37]=t("div",{class:"card-decoration"},[t("div",{class:"decoration-pattern"}),t("div",{class:"card-glow"})],-1)),t("div",$s,[t("div",qs,[t("div",Ps,[t("div",Vs,[t("i",{class:p(e.type==="product"?"fas fa-shopping-bag":"fas fa-bed")},null,2)]),t("div",zs,[t("h3",Bs,i(e.orderNo||e.orderNumber),1),t("div",Fs,[t("span",Es,[s[14]||(s[14]=t("i",{class:"fas fa-clock"},null,-1)),m(" "+i(S(e.createdAt||e.createTime)),1)]),t("span",{class:p(["order-type",e.type])},[t("i",{class:p(e.type==="product"?"fas fa-tag":"fas fa-home")},null,2),m(" "+i(e.type==="product"?"产品订单":"房间订单"),1)],2)])])])]),t("div",Ls,[t("div",{class:p(["order-status",e.status])},[t("div",Rs,[t("i",{class:p(G(e.status))},null,2)]),t("span",Us,i(J(e.status)),1),e.status==="pending"?(l(),n("div",Js)):r("",!0)],2)])]),t("div",Gs,[e.type!=="product"?(l(),n("div",Hs,[t("div",Ks,[t("img",{src:e.roomImage||"/src/assets/images/实地调研/房间参观/房间参观1.jpg",alt:e.roomName,class:"room-image"},null,8,Qs),s[15]||(s[15]=t("div",{class:"image-overlay"},[t("div",{class:"overlay-content"},[t("i",{class:"fas fa-eye"}),t("span",null,"查看详情")])],-1)),s[16]||(s[16]=t("div",{class:"image-frame"},null,-1))]),t("div",Ws,[t("div",Xs,[t("h4",Ys,[s[17]||(s[17]=t("i",{class:"fas fa-home"},null,-1)),m(" "+i(e.roomName),1)]),s[18]||(s[18]=y('<div class="room-rating" data-v-880058c8><div class="stars" data-v-880058c8><i class="fas fa-star" data-v-880058c8></i><i class="fas fa-star" data-v-880058c8></i><i class="fas fa-star" data-v-880058c8></i><i class="fas fa-star" data-v-880058c8></i><i class="fas fa-star" data-v-880058c8></i></div><span class="rating-text" data-v-880058c8>5.0</span></div>',1))]),t("p",Zs,[s[19]||(s[19]=t("i",{class:"fas fa-tag"},null,-1)),m(" "+i(e.roomType),1)]),t("div",st,[t("div",tt,[s[21]||(s[21]=t("div",{class:"stay-icon"},[t("i",{class:"fas fa-calendar-check"})],-1)),t("div",at,[s[20]||(s[20]=t("span",{class:"stay-label"},"入住",-1)),t("span",et,i(S(e.checkInDate)),1)])]),s[25]||(s[25]=t("div",{class:"stay-separator"},[t("i",{class:"fas fa-arrow-right"})],-1)),t("div",ot,[s[23]||(s[23]=t("div",{class:"stay-icon"},[t("i",{class:"fas fa-calendar-times"})],-1)),t("div",it,[s[22]||(s[22]=t("span",{class:"stay-label"},"退房",-1)),t("span",nt,i(S(e.checkOutDate)),1)])]),t("div",lt,[s[24]||(s[24]=t("i",{class:"fas fa-moon"},null,-1)),t("span",null,i(e.nights)+"晚",1)])])])])):r("",!0),e.type==="product"?(l(),n("div",ct,[(l(!0),n(b,null,N(e.items,c=>(l(),n("div",{key:c.id,class:"product-item"},[t("img",{src:c.image,alt:c.name,class:"product-image"},null,8,dt),t("div",rt,[t("h4",ut,i(c.name),1),t("p",pt,i(c.description),1),c.specs?(l(),n("div",vt,[(l(!0),n(b,null,N(c.specs.slice(0,2),q=>(l(),n("span",{key:q,class:"spec-tag"},i(q),1))),128))])):r("",!0)]),t("div",mt,[t("span",null,"x"+i(c.quantity),1)]),t("div",ft,[t("span",gt,"¥"+i((c.price*c.quantity).toFixed(2)),1)])]))),128)),t("div",_t,[t("div",ht,[s[26]||(s[26]=t("span",{class:"label"},"收货地址：",-1)),t("span",yt,i(e.shippingAddress),1)]),t("div",bt,[s[27]||(s[27]=t("span",{class:"label"},"联系电话：",-1)),t("span",kt,i(e.contactPhone),1)])])])):r("",!0),t("div",wt,[t("div",At,[t("div",Ct,[t("div",Dt,[s[28]||(s[28]=t("span",{class:"price-label"},[t("i",{class:"fas fa-bed"}),m(" 房费 ")],-1)),t("span",Nt,"¥"+i(e.roomPrice)+" × "+i(e.nights)+"晚",1)]),s[31]||(s[31]=t("div",{class:"price-divider"},null,-1)),t("div",Ot,[s[30]||(s[30]=t("span",{class:"price-label"},[t("i",{class:"fas fa-calculator"}),m(" 总计 ")],-1)),t("span",It,[s[29]||(s[29]=t("span",{class:"currency"},"¥",-1)),t("span",St,i(e.totalAmount),1)])])]),s[32]||(s[32]=t("div",{class:"price-decoration"},[t("div",{class:"price-glow"})],-1))])])]),t("div",Mt,[t("div",Tt,[e.status==="pending"?(l(),n("button",{key:0,onClick:O(c=>K(e),["stop"]),class:"btn btn-outline btn-danger btn-animated"},s[33]||(s[33]=[t("i",{class:"fas fa-times"},null,-1),t("span",null,"取消订单",-1),t("div",{class:"btn-ripple"},null,-1)]),8,xt)):r("",!0),e.status==="confirmed"?(l(),n("button",{key:1,onClick:O(c=>M(e),["stop"]),class:"btn btn-outline btn-animated"},s[34]||(s[34]=[t("i",{class:"fas fa-eye"},null,-1),t("span",null,"查看详情",-1),t("div",{class:"btn-ripple"},null,-1)]),8,jt)):r("",!0),e.status==="completed"?(l(),n("button",{key:2,onClick:O(c=>Q(e),["stop"]),class:"btn btn-primary btn-animated"},s[35]||(s[35]=[t("i",{class:"fas fa-star"},null,-1),t("span",null,"评价订单",-1),t("div",{class:"btn-ripple"},null,-1)]),8,$t)):r("",!0),t("button",{onClick:O(c=>M(e),["stop"]),class:"btn btn-outline btn-animated"},s[36]||(s[36]=[t("i",{class:"fas fa-file-alt"},null,-1),t("span",null,"订单详情",-1),t("div",{class:"btn-ripple"},null,-1)]),8,qt)])])],8,js))),128))]))],64)):(l(),n("div",Is,[s[7]||(s[7]=t("div",{class:"prompt-animation"},[t("div",{class:"lock-icon"},[t("i",{class:"fas fa-user-lock"}),t("div",{class:"lock-pulse"})])],-1)),s[8]||(s[8]=t("h3",null,"请先登录",-1)),s[9]||(s[9]=t("p",null,"登录后即可查看您的订单信息",-1)),t("div",Ss,[D(o,{to:"/login",class:"btn btn-primary btn-animated"},{default:x(()=>s[5]||(s[5]=[t("span",null,"立即登录",-1),t("div",{class:"btn-shine"},null,-1)])),_:1,__:[5]}),D(o,{to:"/register",class:"btn btn-outline btn-animated"},{default:x(()=>s[6]||(s[6]=[t("span",null,"注册账号",-1),t("div",{class:"btn-shine"},null,-1)])),_:1,__:[6]})])]))])])])])}}}),Rt=ns(Pt,[["__scopeId","data-v-880058c8"]]);export{Rt as default};
