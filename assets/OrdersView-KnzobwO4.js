import{d as Z,u as ss,N as as,a as ts,b as T,c as C,o as es,e as ns,f as i,g as l,h as D,j as h,i as a,A as os,l as r,O as P,t as o,F as b,k as N,x,p,s as m,w as O,_ as is}from"./index-PKPpSeMn.js";import{useCartStore as ls}from"./cart-VeAnoIMX.js";import{r as V}from"./request-DzKJqaQU.js";import{p as cs}from"./ProductAIService-D9KPJfMK.js";import{A as ds}from"./aos-CydkosTY.js";const rs={class:"orders-page"},us={class:"orders-main"},ps={class:"orders-container"},vs={class:"page-header","data-aos":"fade-down","data-aos-duration":"800"},ms={key:0,class:"stats-preview"},fs={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"200"},gs={class:"stat-number"},_s={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"400"},ys={class:"stat-number"},hs={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"600"},bs={class:"stat-number"},ks={class:"order-filters","data-aos":"fade-up","data-aos-delay":"300"},ws={class:"filters-container"},As=["onClick","data-aos-delay"],Cs={class:"filter-icon"},Ds={class:"filter-text"},Ns={key:0,class:"count"},Os={class:"orders-section"},Is={key:0,class:"login-prompt","data-aos":"fade-up"},Ss={class:"prompt-actions"},Ms={key:0,class:"loading","data-aos":"fade-in"},Ts={key:1,class:"no-orders","data-aos":"fade-up"},xs={key:2,class:"orders-list"},js=["data-aos-delay","onClick"],$s={class:"order-header"},qs={class:"order-info"},Ps={class:"order-number-section"},Vs={class:"order-icon"},zs={class:"order-details"},Bs={class:"order-number"},Fs={class:"order-meta"},Es={class:"order-date"},Ls={class:"order-status-container"},Rs={class:"status-icon"},Us={class:"status-text"},Js={key:0,class:"status-pulse"},Gs={class:"order-content"},Hs={key:0,class:"room-info"},Ks={class:"room-image-container"},Qs=["src","alt"],Ws={class:"room-details"},Xs={class:"room-header"},Ys={class:"room-name"},Zs={class:"room-type"},sa={class:"stay-info"},aa={class:"stay-item"},ta={class:"stay-details"},ea={class:"stay-value"},na={class:"stay-item"},oa={class:"stay-details"},ia={class:"stay-value"},la={class:"nights-badge"},ca={key:1,class:"product-info"},da=["src","alt"],ra={class:"product-details"},ua={class:"product-name"},pa={class:"product-desc"},va={key:0,class:"product-specs"},ma={class:"product-quantity"},fa={class:"product-price"},ga={class:"current-price"},_a={class:"shipping-info"},ya={class:"info-item"},ha={class:"value"},ba={class:"info-item"},ka={class:"value"},wa={class:"order-price"},Aa={class:"price-container"},Ca={class:"price-breakdown"},Da={class:"price-item"},Na={class:"price-calculation"},Oa={class:"price-item total"},Ia={class:"total-amount"},Sa={class:"amount"},Ma={class:"order-actions"},Ta={class:"actions-container"},xa=["onClick"],ja=["onClick"],$a=["onClick"],qa=["onClick"],Pa=Z({__name:"OrdersView",setup(Va){const u=ss(),k=as(),v=ts(),f=ls(),I=T(!1),g=T([]),_=T("all"),z={201:"/src/assets/images/实地调研/房间参观/房间参观1.jpg",202:"/src/assets/images/实地调研/房间参观/房间参观1.jpg",301:"/src/assets/images/实地调研/房间参观/房间参观2.jpg",302:"/src/assets/images/实地调研/房间参观/房间参观2.jpg",401:"/src/assets/images/实地调研/室内调研/室内3.jpg",402:"/src/assets/images/实地调研/室内调研/室内3.jpg",501:"/src/assets/images/实地调研/室内调研/室内5.jpg",502:"/src/assets/images/实地调研/室内调研/室内5.jpg",601:"/src/assets/images/实地调研/室内调研/室内7.jpg",602:"/src/assets/images/实地调研/室内调研/室内7.jpg"},B={201:"蘑菇森林小屋",202:"蘑菇森林小屋",301:"蘑菇生态园",302:"蘑菇生态园",401:"茶文化体验馆",402:"茶文化体验馆",501:"普洱茶园",502:"普洱茶园",601:"生态餐厅",602:"生态餐厅"},j=[{value:"all",label:"全部订单"},{value:"pending",label:"待确认"},{value:"confirmed",label:"已确认"},{value:"completed",label:"已完成"},{value:"cancelled",label:"已取消"}],F=t=>({待发货:"pending",已发货:"confirmed",已完成:"completed",已取消:"cancelled"})[t]||"pending",E=C(()=>f.getUserOrders().map(t=>({id:t.id,orderNo:t.id,orderNumber:t.id,status:F(t.status),originalStatus:t.status,totalAmount:t.totalAmount,createdAt:t.createdAt,createTime:t.createdAt,type:"product",items:t.items,shippingAddress:t.shippingAddress,contactPhone:t.contactPhone,remarks:t.remarks,roomName:"周边产品",roomType:"产品订单",roomImage:t.items?.[0]?.image||"/src/assets/images/周边产品/普洱茶叶1.jpg"}))),y=C(()=>[...g.value,...E.value].sort((t,s)=>{const n=new Date(t.createdAt||t.createTime).getTime();return new Date(s.createdAt||s.createTime).getTime()-n})),$=C(()=>_.value==="all"?y.value:y.value.filter(t=>t.status===_.value)),L=C(()=>{const t=j.find(s=>s.value===_.value);return t?t.label.replace("订单",""):""}),R=(t,s)=>{if(!t||!s)return 0;const n=new Date(t),d=new Date(s).getTime()-n.getTime(),c=Math.ceil(d/(1e3*60*60*24));return c>0?c:0},U=(t,s)=>t?{预订:"pending",入住:"confirmed",完成:"completed",取消:"cancelled",删除:"cancelled"}[t]||"pending":{0:"pending",1:"completed",2:"cancelled",3:"cancelled",pending:"pending",confirmed:"confirmed",completed:"completed",cancelled:"cancelled"}[s||0]||"pending",w=async()=>{I.value=!0;try{const t=await V.get("/h/order/getUserOrders");if(console.log("订单列表响应:",t),t.code===200||t.code==="200")t.data&&Array.isArray(t.data.records)?(g.value=t.data.records.map(s=>{const n=s.roomCode||s.roomName;return{id:s.id,orderNumber:s.orderNumber||`MG${s.id.toString().padStart(8,"0")}`,roomName:B[n]||s.roomName||n||"房间名称",roomType:s.roomType||"房间类型",roomImage:z[n]||s.roomImage||"/src/assets/images/实地调研/房间参观/房间参观1.jpg",checkInDate:s.startDate,checkOutDate:s.endDate,nights:s.days||R(s.startDate,s.endDate),roomPrice:s.roomPrice||s.price,totalAmount:s.total||s.amount,status:U(s.state,s.status),state:s.state,systemStatus:s.status,createTime:s.createTime,guestCount:s.amount,phone:s.phone,specialRequirements:s.userRemark}}),console.log("处理后的订单列表:",g.value)):(g.value=[],console.log("没有订单数据，设置为空数组"));else throw new Error(t.msg||"获取订单列表失败")}catch(t){if(console.error("获取订单列表失败:",t),g.value=[],t.response&&t.response.status===401)console.log("401错误，跳转到登录页"),alert("登录已过期，请重新登录"),v.logout(),u.push("/login");else if(t.response&&t.response.status===500){const s=t.response.data?.message||t.message||"";console.log("500错误，错误信息:",s),s.includes("Token无效")||s.includes("NotLoginException")?(alert("登录已过期，请重新登录"),v.logout(),u.push("/login")):alert("获取订单列表失败，请稍后重试")}else t.message&&t.message.includes("登录已过期")?(console.log("Token过期错误，跳转到登录页"),v.logout(),u.push("/login")):(console.log("其他错误:",t.message),alert("获取订单列表失败，请稍后重试"))}finally{I.value=!1}},A=t=>t==="all"?y.value.length:y.value.filter(s=>s.status===t).length,J=t=>({pending:"待确认",confirmed:"已确认",completed:"已完成",cancelled:"已取消"})[t]||t,G=t=>({pending:"fas fa-clock",confirmed:"fas fa-check-circle",completed:"fas fa-star",cancelled:"fas fa-times-circle"})[t]||"fas fa-question-circle",H=t=>({all:"fas fa-list",pending:"fas fa-clock",confirmed:"fas fa-check-circle",completed:"fas fa-star",cancelled:"fas fa-times-circle"})[t]||"fas fa-list",S=t=>new Date(t).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}),K=async t=>{if(console.log("取消订单:",t),confirm("确定要取消这个订单吗？"))try{if(t.type==="product"){const s=f.orders.findIndex(n=>n.id===t.id);if(s!==-1){f.orders[s].status="已取消",localStorage.setItem("product_orders",JSON.stringify(f.orders)),alert("订单已取消");return}}else{if(t.state!=="预订"){alert(`只有预订状态的订单才能取消，当前状态：${t.state||"未知"}`);return}console.log("取消订单请求:",t.id);const s=await V.delete(`/h/order/${t.id}`);if(console.log("取消订单响应:",s),s.code===200||s.code==="200")alert("订单已取消"),w(),window.dispatchEvent(new CustomEvent("orderCancelled",{detail:{roomId:t.roomId,orderId:t.id}}));else{const n=s.msg||s.message||"取消订单失败";alert(n),console.error("取消订单失败:",s)}}}catch(s){console.error("取消订单失败:",s);let n="取消订单失败，请稍后重试";s.response&&(s.response.status===404?n="订单不存在或已被删除":s.response.status===403?n="没有权限取消此订单":s.response.data?.msg&&(n=s.response.data.msg)),alert(n)}},M=t=>{u.push(`/order/${t.id}`)},Q=t=>{u.push(`/order/${t.id}/rate`)},W=()=>{if(k.query.action==="create"){const s=k.query.productId,n=parseInt(k.query.quantity)||1,e=k.query.items;if(s)X(s,n);else if(e)try{const d=JSON.parse(e);Y(d)}catch(d){console.error("解析购物车数据失败:",d)}}},X=async(t,s)=>{const n=cs.getProductById(t);if(!n){alert("产品不存在");return}const e={type:"product",productId:n.id,productName:n.name,quantity:s,unitPrice:n.price,totalAmount:n.price*s,status:"pending",createTime:new Date().toISOString()};try{console.log("创建产品订单:",e),alert(`成功创建订单：${n.name} x ${s}`),u.replace("/orders"),w()}catch(d){console.error("创建产品订单失败:",d),alert("创建订单失败，请稍后重试")}},Y=async t=>{const s=t.reduce((e,d)=>e+d.price*d.quantity,0),n={type:"cart",items:t,totalAmount:s,status:"pending",createTime:new Date().toISOString()};try{console.log("创建购物车订单:",n),alert(`成功创建订单，共${t.length}件商品`),u.replace("/orders"),w()}catch(e){console.error("创建购物车订单失败:",e),alert("创建订单失败，请稍后重试")}};return es(()=>{v.isAuthenticated&&(f.initializeUserData(),w()),W(),ds.init({duration:800,easing:"ease-out-cubic",once:!0,offset:50})}),(t,s)=>{const n=ns("router-link");return l(),i("div",rs,[D(os),s[38]||(s[38]=h('<div class="animated-background" data-v-ec3af211><div class="floating-shapes" data-v-ec3af211><div class="shape shape-1" data-v-ec3af211></div><div class="shape shape-2" data-v-ec3af211></div><div class="shape shape-3" data-v-ec3af211></div><div class="shape shape-4" data-v-ec3af211></div><div class="shape shape-5" data-v-ec3af211></div></div></div>',1)),a("main",us,[a("div",ps,[a("div",vs,[s[3]||(s[3]=h('<div class="header-decoration" data-v-ec3af211><div class="decoration-line" data-v-ec3af211></div><div class="decoration-icon" data-v-ec3af211><i class="fas fa-receipt" data-v-ec3af211></i></div><div class="decoration-line" data-v-ec3af211></div></div><h1 class="page-title" data-v-ec3af211><span class="title-text" data-v-ec3af211>我的预订</span><div class="title-underline" data-v-ec3af211></div></h1><p class="page-subtitle" data-v-ec3af211>管理您在普洱蘑菇庄园的美好住宿体验</p>',3)),P(v).isAuthenticated?(l(),i("div",ms,[a("div",fs,[a("div",gs,o(y.value.length),1),s[0]||(s[0]=a("div",{class:"stat-label"},"总订单",-1))]),a("div",_s,[a("div",ys,o(A("completed")),1),s[1]||(s[1]=a("div",{class:"stat-label"},"已完成",-1))]),a("div",hs,[a("div",bs,o(A("pending")),1),s[2]||(s[2]=a("div",{class:"stat-label"},"待确认",-1))])])):r("",!0)]),a("div",ks,[a("div",ws,[(l(),i(b,null,N(j,(e,d)=>a("button",{key:e.value,onClick:c=>_.value=e.value,class:p(["filter-btn",{active:_.value===e.value}]),"data-aos":"fade-up","data-aos-delay":400+d*100},[a("div",Cs,[a("i",{class:p(H(e.value))},null,2)]),a("span",Ds,o(e.label),1),A(e.value)>0?(l(),i("div",Ns,o(A(e.value)),1)):r("",!0),s[4]||(s[4]=a("div",{class:"filter-ripple"},null,-1))],10,As)),64))])]),a("div",Os,[P(v).isAuthenticated?(l(),i(b,{key:1},[I.value?(l(),i("div",Ms,s[10]||(s[10]=[h('<div class="loading-animation" data-v-ec3af211><div class="loading-spinner" data-v-ec3af211><div class="spinner-ring" data-v-ec3af211></div><div class="spinner-ring" data-v-ec3af211></div><div class="spinner-ring" data-v-ec3af211></div></div><div class="loading-dots" data-v-ec3af211><span data-v-ec3af211></span><span data-v-ec3af211></span><span data-v-ec3af211></span></div></div><span class="loading-text" data-v-ec3af211>正在加载您的订单...</span>',2)]))):$.value.length===0?(l(),i("div",Ts,[s[12]||(s[12]=h('<div class="empty-animation" data-v-ec3af211><div class="empty-icon" data-v-ec3af211><i class="fas fa-calendar-times" data-v-ec3af211></i><div class="empty-waves" data-v-ec3af211><div class="wave" data-v-ec3af211></div><div class="wave" data-v-ec3af211></div><div class="wave" data-v-ec3af211></div></div></div></div>',1)),a("h3",null,"暂无"+o(L.value)+"订单",1),s[13]||(s[13]=a("p",null,"开始您的普洱蘑菇庄园之旅吧",-1)),D(n,{to:"/ai-room-selection",class:"btn btn-primary btn-animated"},{default:x(()=>s[11]||(s[11]=[a("span",null,"AI智能选房",-1),a("div",{class:"btn-shine"},null,-1)])),_:1,__:[11]})])):(l(),i("div",xs,[(l(!0),i(b,null,N($.value,(e,d)=>(l(),i("div",{key:e.id,class:"order-card","data-aos":"fade-up","data-aos-delay":d*100,onClick:c=>M(e)},[s[37]||(s[37]=a("div",{class:"card-decoration"},[a("div",{class:"decoration-pattern"}),a("div",{class:"card-glow"})],-1)),a("div",$s,[a("div",qs,[a("div",Ps,[a("div",Vs,[a("i",{class:p(e.type==="product"?"fas fa-shopping-bag":"fas fa-bed")},null,2)]),a("div",zs,[a("h3",Bs,o(e.orderNo||e.orderNumber),1),a("div",Fs,[a("span",Es,[s[14]||(s[14]=a("i",{class:"fas fa-clock"},null,-1)),m(" "+o(S(e.createdAt||e.createTime)),1)]),a("span",{class:p(["order-type",e.type])},[a("i",{class:p(e.type==="product"?"fas fa-tag":"fas fa-home")},null,2),m(" "+o(e.type==="product"?"产品订单":"房间订单"),1)],2)])])])]),a("div",Ls,[a("div",{class:p(["order-status",e.status])},[a("div",Rs,[a("i",{class:p(G(e.status))},null,2)]),a("span",Us,o(J(e.status)),1),e.status==="pending"?(l(),i("div",Js)):r("",!0)],2)])]),a("div",Gs,[e.type!=="product"?(l(),i("div",Hs,[a("div",Ks,[a("img",{src:e.roomImage||"/src/assets/images/实地调研/房间参观/房间参观1.jpg",alt:e.roomName,class:"room-image"},null,8,Qs),s[15]||(s[15]=a("div",{class:"image-overlay"},[a("div",{class:"overlay-content"},[a("i",{class:"fas fa-eye"}),a("span",null,"查看详情")])],-1)),s[16]||(s[16]=a("div",{class:"image-frame"},null,-1))]),a("div",Ws,[a("div",Xs,[a("h4",Ys,[s[17]||(s[17]=a("i",{class:"fas fa-home"},null,-1)),m(" "+o(e.roomName),1)]),s[18]||(s[18]=h('<div class="room-rating" data-v-ec3af211><div class="stars" data-v-ec3af211><i class="fas fa-star" data-v-ec3af211></i><i class="fas fa-star" data-v-ec3af211></i><i class="fas fa-star" data-v-ec3af211></i><i class="fas fa-star" data-v-ec3af211></i><i class="fas fa-star" data-v-ec3af211></i></div><span class="rating-text" data-v-ec3af211>5.0</span></div>',1))]),a("p",Zs,[s[19]||(s[19]=a("i",{class:"fas fa-tag"},null,-1)),m(" "+o(e.roomType),1)]),a("div",sa,[a("div",aa,[s[21]||(s[21]=a("div",{class:"stay-icon"},[a("i",{class:"fas fa-calendar-check"})],-1)),a("div",ta,[s[20]||(s[20]=a("span",{class:"stay-label"},"入住",-1)),a("span",ea,o(S(e.checkInDate)),1)])]),s[25]||(s[25]=a("div",{class:"stay-separator"},[a("i",{class:"fas fa-arrow-right"})],-1)),a("div",na,[s[23]||(s[23]=a("div",{class:"stay-icon"},[a("i",{class:"fas fa-calendar-times"})],-1)),a("div",oa,[s[22]||(s[22]=a("span",{class:"stay-label"},"退房",-1)),a("span",ia,o(S(e.checkOutDate)),1)])]),a("div",la,[s[24]||(s[24]=a("i",{class:"fas fa-moon"},null,-1)),a("span",null,o(e.nights)+"晚",1)])])])])):r("",!0),e.type==="product"?(l(),i("div",ca,[(l(!0),i(b,null,N(e.items,c=>(l(),i("div",{key:c.id,class:"product-item"},[a("img",{src:c.image,alt:c.name,class:"product-image"},null,8,da),a("div",ra,[a("h4",ua,o(c.name),1),a("p",pa,o(c.description),1),c.specs?(l(),i("div",va,[(l(!0),i(b,null,N(c.specs.slice(0,2),q=>(l(),i("span",{key:q,class:"spec-tag"},o(q),1))),128))])):r("",!0)]),a("div",ma,[a("span",null,"x"+o(c.quantity),1)]),a("div",fa,[a("span",ga,"¥"+o((c.price*c.quantity).toFixed(2)),1)])]))),128)),a("div",_a,[a("div",ya,[s[26]||(s[26]=a("span",{class:"label"},"收货地址：",-1)),a("span",ha,o(e.shippingAddress),1)]),a("div",ba,[s[27]||(s[27]=a("span",{class:"label"},"联系电话：",-1)),a("span",ka,o(e.contactPhone),1)])])])):r("",!0),a("div",wa,[a("div",Aa,[a("div",Ca,[a("div",Da,[s[28]||(s[28]=a("span",{class:"price-label"},[a("i",{class:"fas fa-bed"}),m(" 房费 ")],-1)),a("span",Na,"¥"+o(e.roomPrice)+" × "+o(e.nights)+"晚",1)]),s[31]||(s[31]=a("div",{class:"price-divider"},null,-1)),a("div",Oa,[s[30]||(s[30]=a("span",{class:"price-label"},[a("i",{class:"fas fa-calculator"}),m(" 总计 ")],-1)),a("span",Ia,[s[29]||(s[29]=a("span",{class:"currency"},"¥",-1)),a("span",Sa,o(e.totalAmount),1)])])]),s[32]||(s[32]=a("div",{class:"price-decoration"},[a("div",{class:"price-glow"})],-1))])])]),a("div",Ma,[a("div",Ta,[e.status==="pending"?(l(),i("button",{key:0,onClick:O(c=>K(e),["stop"]),class:"btn btn-outline btn-danger btn-animated"},s[33]||(s[33]=[a("i",{class:"fas fa-times"},null,-1),a("span",null,"取消订单",-1),a("div",{class:"btn-ripple"},null,-1)]),8,xa)):r("",!0),e.status==="confirmed"?(l(),i("button",{key:1,onClick:O(c=>M(e),["stop"]),class:"btn btn-outline btn-animated"},s[34]||(s[34]=[a("i",{class:"fas fa-eye"},null,-1),a("span",null,"查看详情",-1),a("div",{class:"btn-ripple"},null,-1)]),8,ja)):r("",!0),e.status==="completed"?(l(),i("button",{key:2,onClick:O(c=>Q(e),["stop"]),class:"btn btn-primary btn-animated"},s[35]||(s[35]=[a("i",{class:"fas fa-star"},null,-1),a("span",null,"评价订单",-1),a("div",{class:"btn-ripple"},null,-1)]),8,$a)):r("",!0),a("button",{onClick:O(c=>M(e),["stop"]),class:"btn btn-outline btn-animated"},s[36]||(s[36]=[a("i",{class:"fas fa-file-alt"},null,-1),a("span",null,"订单详情",-1),a("div",{class:"btn-ripple"},null,-1)]),8,qa)])])],8,js))),128))]))],64)):(l(),i("div",Is,[s[7]||(s[7]=a("div",{class:"prompt-animation"},[a("div",{class:"lock-icon"},[a("i",{class:"fas fa-user-lock"}),a("div",{class:"lock-pulse"})])],-1)),s[8]||(s[8]=a("h3",null,"请先登录",-1)),s[9]||(s[9]=a("p",null,"登录后即可查看您的订单信息",-1)),a("div",Ss,[D(n,{to:"/login",class:"btn btn-primary btn-animated"},{default:x(()=>s[5]||(s[5]=[a("span",null,"立即登录",-1),a("div",{class:"btn-shine"},null,-1)])),_:1,__:[5]}),D(n,{to:"/register",class:"btn btn-outline btn-animated"},{default:x(()=>s[6]||(s[6]=[a("span",null,"注册账号",-1),a("div",{class:"btn-shine"},null,-1)])),_:1,__:[6]})])]))])])])])}}}),Ra=is(Pa,[["__scopeId","data-v-ec3af211"]]);export{Ra as default};
