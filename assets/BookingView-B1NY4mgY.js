import{d as M,u as N,Q as U,a as E,b as I,r as $,c as k,o as A,e as P,f as d,g as c,i as o,s as i,h as m,x as p,t as u,L as w,w as F,l as b,m as h,v as y,M as J,_ as L}from"./index-vYzfv9NW.js";import{r as R}from"./request-DzKJqaQU.js";const Q={class:"booking-page"},z={class:"navbar"},H={class:"nav-container"},K={class:"nav-menu"},W={class:"nav-buttons"},X={class:"user-welcome"},Y={class:"main-content"},Z={key:0,class:"loading-container"},ee={key:1,class:"booking-container"},oe={class:"booking-content"},se={class:"room-summary"},te={class:"room-image"},ae=["src","alt"],ne={class:"room-info"},le={class:"room-type"},re={class:"room-price"},ie={class:"price"},ue={class:"booking-form"},de={class:"form-group"},ce=["min"],me={class:"form-group"},pe=["min"],ve={class:"form-group"},ge={key:0,value:"3"},fe={key:1,value:"4"},ke={class:"form-group"},he=["placeholder"],_e={class:"form-group"},be={key:0,class:"cost-breakdown"},ye={class:"cost-item"},De={class:"cost-total"},Ce={class:"total-amount"},Ie={class:"form-actions"},we=["disabled"],xe={key:0,class:"fas fa-spinner fa-spin"},Oe={key:2,class:"error-container"},Ve=M({__name:"BookingView",setup(qe){const v=N(),D=U(),r=E(),C=I(!0),g=I(!1),s=I(null),t=$({checkInDate:"",checkOutDate:"",guestCount:"2",phone:"",specialRequirements:""}),x=k(()=>new Date().toISOString().split("T")[0]),S=k(()=>{if(!t.checkInDate)return x.value;const n=new Date(t.checkInDate);return n.setDate(n.getDate()+1),n.toISOString().split("T")[0]}),f=k(()=>{if(!t.checkInDate||!t.checkOutDate)return 0;const n=new Date(t.checkInDate),l=new Date(t.checkOutDate).getTime()-n.getTime(),a=Math.ceil(l/(1e3*60*60*24));return a>0?a:0}),_=k(()=>!s.value||f.value<=0?0:f.value*s.value.price),O=k(()=>t.checkInDate&&t.checkOutDate&&t.guestCount&&t.phone&&f.value>0),j=async()=>{C.value=!0;try{const n=D.params.id,e=await R.get(`/h/room/detail?id=${n}`);if(e.code===200&&e.data){if(s.value={...e.data.room,status:e.data.room.status===0?"available":"booked",maxGuests:e.data.room.maxGuests||e.data.room.seat||2,image:e.data.img?.[0]?.url||`http://localhost:8091/files/${e.data.room.banner}`||"/src/assets/images/实地调研/房间参观/房间参观1.jpg"},console.log("房间详情获取成功:",s.value),console.log("原始API响应:",e.data),console.log("房间名称:",e.data.room?.name),s.value.status!=="available"){alert("抱歉，该房间已被预订"),v.push("/ai-rooms");return}}else throw new Error("获取房间详情失败")}catch(n){console.error("获取房间详情失败:",n);const e=parseInt(D.params.id),l={1:{name:"蘑菇森林小屋",type:"豪华间",price:388,image:"/src/assets/images/card/card01.jpg",code:"201"},2:{name:"蘑菇森林小屋",type:"豪华间",price:388,image:"/src/assets/images/card/card01.jpg",code:"202"},3:{name:"蘑菇生态园",type:"标准间",price:288,image:"/src/assets/images/card/card02.jpg",code:"301"},4:{name:"蘑菇生态园",type:"标准间",price:288,image:"/src/assets/images/card/card02.jpg",code:"302"},5:{name:"茶文化体验馆",type:"特色间",price:358,image:"/src/assets/images/card/card03.jpg",code:"401"},6:{name:"茶文化体验馆",type:"特色间",price:358,image:"/src/assets/images/card/card03.jpg",code:"402"},7:{name:"普洱茶园",type:"豪华间",price:468,image:"/src/assets/images/card/card04.JPG",code:"501"},8:{name:"普洱茶园",type:"豪华间",price:468,image:"/src/assets/images/card/card04.JPG",code:"502"},9:{name:"生态餐厅",type:"套房",price:588,image:"/src/assets/images/card/card05.jpg",code:"601"},10:{name:"生态餐厅",type:"套房",price:588,image:"/src/assets/images/card/card05.jpg",code:"602"}},a=l[e]||l[1];s.value={id:e,name:a.name,type:a.type,price:a.price,status:"available",maxGuests:2,image:a.image,roomCode:a.code,code:a.code},console.log("使用模拟数据:",s.value)}finally{C.value=!1}},V=()=>{},T=async()=>{if(O.value){g.value=!0;try{const n={username:r.user?.realName||r.user?.name||r.user?.email,phone:t.phone,startDate:t.checkInDate,endDate:t.checkOutDate,amount:parseInt(t.guestCount),roomId:parseInt(s.value.id),roomCode:s.value.roomCode||s.value.name||`房间${s.value.id}`,userRemark:t.specialRequirements||"",state:"预订",total:_.value.toString(),payState:0,status:0,days:f.value};console.log("🔍 订单创建调试信息:"),console.log("room.value:",s.value),console.log("room.value.roomCode:",s.value.roomCode),console.log("room.value.name:",s.value.name),console.log("最终使用的roomCode:",n.roomCode),console.log("完整订单数据:",n),console.log("提交预订数据:",n);const e=await R.post("/h/order",n);e.code===200?(alert("预订成功！请等待管理员确认。"),window.dispatchEvent(new CustomEvent("roomBooked",{detail:{roomId:s.value.id,roomCode:s.value.roomCode||s.value.code,status:"booked"}})),v.push("/orders")):alert(e.msg||"预订失败，请重试")}catch(n){console.error("提交预订失败:",n),alert("预订失败，请重试")}finally{g.value=!1}}},q=()=>{v.push(`/room/${D.params.id}`)},B=()=>{v.push("/ai-rooms")},G=()=>{r.logout(),v.push("/login")};return A(()=>{j(),r.user?.phone&&(t.phone=r.user.phone)}),(n,e)=>{const l=P("router-link");return c(),d("div",Q,[o("nav",z,[o("div",H,[e[11]||(e[11]=o("div",{class:"logo"},[o("i",{class:"fas fa-seedling"}),i(" 普洱蘑菇庄园 ")],-1)),o("div",K,[m(l,{to:"/",class:"nav-link"},{default:p(()=>e[5]||(e[5]=[i("首页")])),_:1,__:[5]}),m(l,{to:"/tea-culture",class:"nav-link"},{default:p(()=>e[6]||(e[6]=[i("茶文化")])),_:1,__:[6]}),m(l,{to:"/products",class:"nav-link"},{default:p(()=>e[7]||(e[7]=[i("民宿产品")])),_:1,__:[7]}),m(l,{to:"/ai-rooms",class:"nav-link"},{default:p(()=>e[8]||(e[8]=[i("AI选房")])),_:1,__:[8]}),m(l,{to:"/orders",class:"nav-link"},{default:p(()=>e[9]||(e[9]=[i("订单")])),_:1,__:[9]}),m(l,{to:"/profile",class:"nav-link"},{default:p(()=>e[10]||(e[10]=[i("个人信息")])),_:1,__:[10]})]),o("div",W,[o("span",X,"欢迎，"+u(w(r).user?.realName||w(r).user?.username),1),o("button",{onClick:G,class:"btn btn-outline"},"退出登录")])])]),o("main",Y,[C.value?(c(),d("div",Z,e[12]||(e[12]=[o("i",{class:"fas fa-spinner fa-spin"},null,-1),o("span",null,"加载中...",-1)]))):s.value?(c(),d("div",ee,[o("div",{class:"back-section"},[o("button",{onClick:q,class:"back-btn"},e[13]||(e[13]=[o("i",{class:"fas fa-arrow-left"},null,-1),i(" 返回房间详情 ")]))]),o("div",oe,[o("div",se,[o("div",te,[o("img",{src:s.value.image||s.value.images?.[0]||"/api/placeholder/300/200",alt:s.value.name},null,8,ae)]),o("div",ne,[o("h2",null,u(s.value.name),1),o("p",le,u(s.value.type),1),o("div",re,[o("span",ie,"¥"+u(s.value.price),1),e[14]||(e[14]=o("span",{class:"unit"},"/晚",-1))])])]),o("div",ue,[e[24]||(e[24]=o("div",{class:"form-header"},[o("h3",null,"预订信息"),o("p",{class:"form-subtitle"},"请填写您的入住信息")],-1)),o("form",{onSubmit:F(T,["prevent"]),class:"booking-form-content"},[o("div",de,[e[15]||(e[15]=o("label",{for:"checkIn"},"入住日期",-1)),h(o("input",{type:"date",id:"checkIn","onUpdate:modelValue":e[0]||(e[0]=a=>t.checkInDate=a),min:x.value,required:"",onChange:V},null,40,ce),[[y,t.checkInDate]])]),o("div",me,[e[16]||(e[16]=o("label",{for:"checkOut"},"退房日期",-1)),h(o("input",{type:"date",id:"checkOut","onUpdate:modelValue":e[1]||(e[1]=a=>t.checkOutDate=a),min:S.value,required:"",onChange:V},null,40,pe),[[y,t.checkOutDate]])]),o("div",ve,[e[19]||(e[19]=o("label",{for:"guests"},"入住人数",-1)),h(o("select",{id:"guests","onUpdate:modelValue":e[2]||(e[2]=a=>t.guestCount=a),required:""},[e[17]||(e[17]=o("option",{value:"1"},"1人",-1)),e[18]||(e[18]=o("option",{value:"2"},"2人",-1)),s.value.maxGuests>=3?(c(),d("option",ge,"3人")):b("",!0),s.value.maxGuests>=4?(c(),d("option",fe,"4人")):b("",!0)],512),[[J,t.guestCount]])]),o("div",ke,[e[20]||(e[20]=o("label",{for:"phone"},"联系电话",-1)),h(o("input",{type:"tel",id:"phone","onUpdate:modelValue":e[3]||(e[3]=a=>t.phone=a),placeholder:w(r).user?.phone||"请输入联系电话",required:""},null,8,he),[[y,t.phone]])]),o("div",_e,[e[21]||(e[21]=o("label",{for:"requirements"},"特殊要求（可选）",-1)),h(o("textarea",{id:"requirements","onUpdate:modelValue":e[4]||(e[4]=a=>t.specialRequirements=a),placeholder:"如有特殊需求，请在此说明...",rows:"3"},null,512),[[y,t.specialRequirements]])]),_.value>0?(c(),d("div",be,[e[23]||(e[23]=o("h4",null,"费用明细",-1)),o("div",ye,[o("span",null,"房费 ("+u(f.value)+"晚 × ¥"+u(s.value.price)+")",1),o("span",null,"¥"+u(_.value),1)]),o("div",De,[e[22]||(e[22]=o("span",null,"总计",-1)),o("span",Ce,"¥"+u(_.value),1)])])):b("",!0),o("div",Ie,[o("button",{type:"button",onClick:q,class:"btn btn-secondary"},"取消"),o("button",{type:"submit",class:"btn btn-primary",disabled:!O.value||g.value},[g.value?(c(),d("i",xe)):b("",!0),i(" "+u(g.value?"提交中...":"确认预订"),1)],8,we)])],32)])])])):(c(),d("div",Oe,[e[25]||(e[25]=o("i",{class:"fas fa-exclamation-triangle"},null,-1)),e[26]||(e[26]=o("h3",null,"房间不存在",-1)),e[27]||(e[27]=o("p",null,"抱歉，您要预订的房间不存在或已被删除",-1)),o("button",{onClick:B,class:"btn btn-primary"},"返回房间列表")]))])])}}}),je=L(Ve,[["__scopeId","data-v-13fc861e"]]);export{je as default};
