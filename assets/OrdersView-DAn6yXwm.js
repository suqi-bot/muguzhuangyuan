import{d as os,u as ns,Q as is,a as ls,b as T,c as C,o as cs,e as ds,f as i,g as l,h as D,j as h,i as t,A as rs,l as r,L as V,t as n,F as b,k as N,x,U as z,p,s as m,w as O,_ as us}from"./index-vYzfv9NW.js";import{useCartStore as ps}from"./cart-BWQtXmKZ.js";import{r as B}from"./request-DzKJqaQU.js";import{p as vs}from"./ProductAIService-Dx6Mx-li.js";import{A as ms}from"./aos-CzWz6qMZ.js";import{a as F,i as j,r as E}from"./indoor5-EE3fvsa8.js";const L="/muguzhuangyuan/assets/indoor7-CWPJd__e.jpg",fs={class:"orders-page"},gs={class:"orders-main"},_s={class:"orders-container"},ys={class:"page-header","data-aos":"fade-down","data-aos-duration":"800"},hs={key:0,class:"stats-preview"},bs={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"200"},ks={class:"stat-number"},ws={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"400"},As={class:"stat-number"},Cs={class:"stat-item","data-aos":"zoom-in","data-aos-delay":"600"},Ds={class:"stat-number"},Ns={class:"order-filters","data-aos":"fade-up","data-aos-delay":"300"},Os={class:"filters-container"},Is=["onClick","data-aos-delay"],Ss={class:"filter-icon"},Ms={class:"filter-text"},Ts={key:0,class:"count"},xs={class:"orders-section"},$s={key:0,class:"login-prompt","data-aos":"fade-up"},qs={class:"prompt-actions"},Ps={key:0,class:"loading","data-aos":"fade-in"},Vs={key:1,class:"no-orders","data-aos":"fade-up"},zs={key:2,class:"orders-list"},Bs=["data-aos-delay","onClick"],Fs={class:"order-header"},js={class:"order-info"},Es={class:"order-number-section"},Ls={class:"order-icon"},Rs={class:"order-details"},Us={class:"order-number"},Js={class:"order-meta"},Gs={class:"order-date"},Qs={class:"order-status-container"},Ws={class:"status-icon"},Hs={class:"status-text"},Ks={key:0,class:"status-pulse"},Xs={class:"order-content"},Ys={key:0,class:"room-info"},Zs={class:"room-image-container"},st=["src","alt"],tt={class:"room-details"},at={class:"room-header"},et={class:"room-name"},ot={class:"room-type"},nt={class:"stay-info"},it={class:"stay-item"},lt={class:"stay-details"},ct={class:"stay-value"},dt={class:"stay-item"},rt={class:"stay-details"},ut={class:"stay-value"},pt={class:"nights-badge"},vt={key:1,class:"product-info"},mt=["src","alt"],ft={class:"product-details"},gt={class:"product-name"},_t={class:"product-desc"},yt={key:0,class:"product-specs"},ht={class:"product-quantity"},bt={class:"product-price"},kt={class:"current-price"},wt={class:"shipping-info"},At={class:"info-item"},Ct={class:"value"},Dt={class:"info-item"},Nt={class:"value"},Ot={class:"order-price"},It={class:"price-container"},St={class:"price-breakdown"},Mt={class:"price-item"},Tt={class:"price-calculation"},xt={class:"price-item total"},$t={class:"total-amount"},qt={class:"amount"},Pt={class:"order-actions"},Vt={class:"actions-container"},zt=["onClick"],Bt=["onClick"],Ft=["onClick"],jt=["onClick"],Et=os({__name:"OrdersView",setup(Lt){const u=ns(),k=is(),v=ls(),f=ps(),I=T(!1),g=T([]),_=T("all"),R={201:z,202:z,301:E,302:E,401:j,402:j,501:F,502:F,601:L,602:L},U={201:"蘑菇森林小屋",202:"蘑菇森林小屋",301:"蘑菇生态园",302:"蘑菇生态园",401:"茶文化体验馆",402:"茶文化体验馆",501:"普洱茶园",502:"普洱茶园",601:"生态餐厅",602:"生态餐厅"},$=[{value:"all",label:"全部订单"},{value:"pending",label:"待确认"},{value:"confirmed",label:"已确认"},{value:"completed",label:"已完成"},{value:"cancelled",label:"已取消"}],J=a=>({待发货:"pending",已发货:"confirmed",已完成:"completed",已取消:"cancelled"})[a]||"pending",G=C(()=>f.getUserOrders().map(a=>({id:a.id,orderNo:a.id,orderNumber:a.id,status:J(a.status),originalStatus:a.status,totalAmount:a.totalAmount,createdAt:a.createdAt,createTime:a.createdAt,type:"product",items:a.items,shippingAddress:a.shippingAddress,contactPhone:a.contactPhone,remarks:a.remarks,roomName:"周边产品",roomType:"产品订单",roomImage:a.items?.[0]?.image||"@/assets/images/周边产品/普洱茶叶1.jpg"}))),y=C(()=>[...g.value,...G.value].sort((a,s)=>{const o=new Date(a.createdAt||a.createTime).getTime();return new Date(s.createdAt||s.createTime).getTime()-o})),q=C(()=>_.value==="all"?y.value:y.value.filter(a=>a.status===_.value)),Q=C(()=>{const a=$.find(s=>s.value===_.value);return a?a.label.replace("订单",""):""}),W=(a,s)=>{if(!a||!s)return 0;const o=new Date(a),d=new Date(s).getTime()-o.getTime(),c=Math.ceil(d/(1e3*60*60*24));return c>0?c:0},H=(a,s)=>a?{预订:"pending",入住:"confirmed",完成:"completed",取消:"cancelled",删除:"cancelled"}[a]||"pending":{0:"pending",1:"completed",2:"cancelled",3:"cancelled",pending:"pending",confirmed:"confirmed",completed:"completed",cancelled:"cancelled"}[s||0]||"pending",w=async()=>{I.value=!0;try{const a=await B.get("/h/order/getUserOrders");if(console.log("订单列表响应:",a),a.code===200||a.code==="200")a.data&&Array.isArray(a.data.records)?(g.value=a.data.records.map(s=>{const o=s.roomCode||s.roomName;return{id:s.id,orderNumber:s.orderNumber||`MG${s.id.toString().padStart(8,"0")}`,roomName:U[o]||s.roomName||o||"房间名称",roomType:s.roomType||"房间类型",roomImage:R[o]||s.roomImage||"@/assets/images/实地调研/房间参观/房间参观1.jpg",checkInDate:s.startDate,checkOutDate:s.endDate,nights:s.days||W(s.startDate,s.endDate),roomPrice:s.roomPrice||s.price,totalAmount:s.total||s.amount,status:H(s.state,s.status),state:s.state,systemStatus:s.status,createTime:s.createTime,guestCount:s.amount,phone:s.phone,specialRequirements:s.userRemark}}),console.log("处理后的订单列表:",g.value)):(g.value=[],console.log("没有订单数据，设置为空数组"));else throw new Error(a.msg||"获取订单列表失败")}catch(a){if(console.error("获取订单列表失败:",a),g.value=[],a.response&&a.response.status===401)alert("登录已过期，请重新登录"),v.logout(),u.push("/login");else if(a.response&&a.response.status===500){const s=a.response.data?.message||a.message||"";s.includes("Token无效")||s.includes("NotLoginException")?(alert("登录已过期，请重新登录"),v.logout(),u.push("/login")):alert("获取订单列表失败，请稍后重试")}else a.message&&a.message.includes("登录已过期")?(console.log("Token过期错误，跳转到登录页"),v.logout(),u.push("/login")):(console.log("其他错误:",a.message),alert("获取订单列表失败，请稍后重试"))}finally{I.value=!1}},A=a=>a==="all"?y.value.length:y.value.filter(s=>s.status===a).length,K=a=>({pending:"待确认",confirmed:"已确认",completed:"已完成",cancelled:"已取消"})[a]||a,X=a=>({pending:"fas fa-clock",confirmed:"fas fa-check-circle",completed:"fas fa-star",cancelled:"fas fa-times-circle"})[a]||"fas fa-question-circle",Y=a=>({all:"fas fa-list",pending:"fas fa-clock",confirmed:"fas fa-check-circle",completed:"fas fa-star",cancelled:"fas fa-times-circle"})[a]||"fas fa-list",S=a=>new Date(a).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}),Z=async a=>{if(console.log("取消订单:",a),confirm("确定要取消这个订单吗？"))try{if(a.type==="product"){const s=f.orders.findIndex(o=>o.id===a.id);if(s!==-1){f.orders[s].status="已取消",localStorage.setItem("product_orders",JSON.stringify(f.orders)),alert("订单已取消");return}}else{if(a.state!=="预订"){alert(`只有预订状态的订单才能取消，当前状态：${a.state||"未知"}`);return}console.log("取消订单请求:",a.id);const s=await B.delete(`/h/order/${a.id}`);if(console.log("取消订单响应:",s),s.code===200||s.code==="200")alert("订单已取消"),w(),window.dispatchEvent(new CustomEvent("orderCancelled",{detail:{roomId:a.roomId,orderId:a.id}}));else{const o=s.msg||s.message||"取消订单失败";alert(o),console.error("取消订单失败:",s)}}}catch(s){console.error("取消订单失败:",s);let o="取消订单失败，请稍后重试";s.response&&(s.response.status===404?o="订单不存在或已被删除":s.response.status===403?o="没有权限取消此订单":s.response.data?.msg&&(o=s.response.data.msg)),alert(o)}},M=a=>{u.push(`/order/${a.id}`)},ss=a=>{u.push(`/order/${a.id}/rate`)},ts=()=>{if(k.query.action==="create"){const s=k.query.productId,o=parseInt(k.query.quantity)||1,e=k.query.items;if(s)as(s,o);else if(e)try{const d=JSON.parse(e);es(d)}catch(d){console.error("解析购物车数据失败:",d)}}},as=async(a,s)=>{const o=vs.getProductById(a);if(!o){alert("产品不存在");return}const e={type:"product",productId:o.id,productName:o.name,quantity:s,unitPrice:o.price,totalAmount:o.price*s,status:"pending",createTime:new Date().toISOString()};try{console.log("创建产品订单:",e),alert(`成功创建订单：${o.name} x ${s}`),u.replace("/orders"),w()}catch(d){console.error("创建产品订单失败:",d),alert("创建订单失败，请稍后重试")}},es=async a=>{const s=a.reduce((e,d)=>e+d.price*d.quantity,0),o={type:"cart",items:a,totalAmount:s,status:"pending",createTime:new Date().toISOString()};try{console.log("创建购物车订单:",o),alert(`成功创建订单，共${a.length}件商品`),u.replace("/orders"),w()}catch(e){console.error("创建购物车订单失败:",e),alert("创建订单失败，请稍后重试")}};return cs(()=>{v.isAuthenticated&&(f.initializeUserData(),w()),ts(),ms.init({duration:800,easing:"ease-out-cubic",once:!0,offset:50})}),(a,s)=>{const o=ds("router-link");return l(),i("div",fs,[D(rs),s[38]||(s[38]=h('<div class="animated-background" data-v-7f3ca1c8><div class="floating-shapes" data-v-7f3ca1c8><div class="shape shape-1" data-v-7f3ca1c8></div><div class="shape shape-2" data-v-7f3ca1c8></div><div class="shape shape-3" data-v-7f3ca1c8></div><div class="shape shape-4" data-v-7f3ca1c8></div><div class="shape shape-5" data-v-7f3ca1c8></div></div></div>',1)),t("main",gs,[t("div",_s,[t("div",ys,[s[3]||(s[3]=h('<div class="header-decoration" data-v-7f3ca1c8><div class="decoration-line" data-v-7f3ca1c8></div><div class="decoration-icon" data-v-7f3ca1c8><i class="fas fa-receipt" data-v-7f3ca1c8></i></div><div class="decoration-line" data-v-7f3ca1c8></div></div><h1 class="page-title" data-v-7f3ca1c8><span class="title-text" data-v-7f3ca1c8>我的预订</span><div class="title-underline" data-v-7f3ca1c8></div></h1><p class="page-subtitle" data-v-7f3ca1c8>管理您在普洱蘑菇庄园的美好住宿体验</p>',3)),V(v).isAuthenticated?(l(),i("div",hs,[t("div",bs,[t("div",ks,n(y.value.length),1),s[0]||(s[0]=t("div",{class:"stat-label"},"总订单",-1))]),t("div",ws,[t("div",As,n(A("completed")),1),s[1]||(s[1]=t("div",{class:"stat-label"},"已完成",-1))]),t("div",Cs,[t("div",Ds,n(A("pending")),1),s[2]||(s[2]=t("div",{class:"stat-label"},"待确认",-1))])])):r("",!0)]),t("div",Ns,[t("div",Os,[(l(),i(b,null,N($,(e,d)=>t("button",{key:e.value,onClick:c=>_.value=e.value,class:p(["filter-btn",{active:_.value===e.value}]),"data-aos":"fade-up","data-aos-delay":400+d*100},[t("div",Ss,[t("i",{class:p(Y(e.value))},null,2)]),t("span",Ms,n(e.label),1),A(e.value)>0?(l(),i("div",Ts,n(A(e.value)),1)):r("",!0),s[4]||(s[4]=t("div",{class:"filter-ripple"},null,-1))],10,Is)),64))])]),t("div",xs,[V(v).isAuthenticated?(l(),i(b,{key:1},[I.value?(l(),i("div",Ps,s[10]||(s[10]=[h('<div class="loading-animation" data-v-7f3ca1c8><div class="loading-spinner" data-v-7f3ca1c8><div class="spinner-ring" data-v-7f3ca1c8></div><div class="spinner-ring" data-v-7f3ca1c8></div><div class="spinner-ring" data-v-7f3ca1c8></div></div><div class="loading-dots" data-v-7f3ca1c8><span data-v-7f3ca1c8></span><span data-v-7f3ca1c8></span><span data-v-7f3ca1c8></span></div></div><span class="loading-text" data-v-7f3ca1c8>正在加载您的订单...</span>',2)]))):q.value.length===0?(l(),i("div",Vs,[s[12]||(s[12]=h('<div class="empty-animation" data-v-7f3ca1c8><div class="empty-icon" data-v-7f3ca1c8><i class="fas fa-calendar-times" data-v-7f3ca1c8></i><div class="empty-waves" data-v-7f3ca1c8><div class="wave" data-v-7f3ca1c8></div><div class="wave" data-v-7f3ca1c8></div><div class="wave" data-v-7f3ca1c8></div></div></div></div>',1)),t("h3",null,"暂无"+n(Q.value)+"订单",1),s[13]||(s[13]=t("p",null,"开始您的普洱蘑菇庄园之旅吧",-1)),D(o,{to:"/ai-rooms",class:"btn btn-primary btn-animated"},{default:x(()=>s[11]||(s[11]=[t("span",null,"AI智能选房",-1),t("div",{class:"btn-shine"},null,-1)])),_:1,__:[11]})])):(l(),i("div",zs,[(l(!0),i(b,null,N(q.value,(e,d)=>(l(),i("div",{key:e.id,class:"order-card","data-aos":"fade-up","data-aos-delay":d*100,onClick:c=>M(e)},[s[37]||(s[37]=t("div",{class:"card-decoration"},[t("div",{class:"decoration-pattern"}),t("div",{class:"card-glow"})],-1)),t("div",Fs,[t("div",js,[t("div",Es,[t("div",Ls,[t("i",{class:p(e.type==="product"?"fas fa-shopping-bag":"fas fa-bed")},null,2)]),t("div",Rs,[t("h3",Us,n(e.orderNo||e.orderNumber),1),t("div",Js,[t("span",Gs,[s[14]||(s[14]=t("i",{class:"fas fa-clock"},null,-1)),m(" "+n(S(e.createdAt||e.createTime)),1)]),t("span",{class:p(["order-type",e.type])},[t("i",{class:p(e.type==="product"?"fas fa-tag":"fas fa-home")},null,2),m(" "+n(e.type==="product"?"产品订单":"房间订单"),1)],2)])])])]),t("div",Qs,[t("div",{class:p(["order-status",e.status])},[t("div",Ws,[t("i",{class:p(X(e.status))},null,2)]),t("span",Hs,n(K(e.status)),1),e.status==="pending"?(l(),i("div",Ks)):r("",!0)],2)])]),t("div",Xs,[e.type!=="product"?(l(),i("div",Ys,[t("div",Zs,[t("img",{src:e.roomImage||"@/assets/images/实地调研/房间参观/房间参观1.jpg",alt:e.roomName,class:"room-image"},null,8,st),s[15]||(s[15]=t("div",{class:"image-overlay"},[t("div",{class:"overlay-content"},[t("i",{class:"fas fa-eye"}),t("span",null,"查看详情")])],-1)),s[16]||(s[16]=t("div",{class:"image-frame"},null,-1))]),t("div",tt,[t("div",at,[t("h4",et,[s[17]||(s[17]=t("i",{class:"fas fa-home"},null,-1)),m(" "+n(e.roomName),1)]),s[18]||(s[18]=h('<div class="room-rating" data-v-7f3ca1c8><div class="stars" data-v-7f3ca1c8><i class="fas fa-star" data-v-7f3ca1c8></i><i class="fas fa-star" data-v-7f3ca1c8></i><i class="fas fa-star" data-v-7f3ca1c8></i><i class="fas fa-star" data-v-7f3ca1c8></i><i class="fas fa-star" data-v-7f3ca1c8></i></div><span class="rating-text" data-v-7f3ca1c8>5.0</span></div>',1))]),t("p",ot,[s[19]||(s[19]=t("i",{class:"fas fa-tag"},null,-1)),m(" "+n(e.roomType),1)]),t("div",nt,[t("div",it,[s[21]||(s[21]=t("div",{class:"stay-icon"},[t("i",{class:"fas fa-calendar-check"})],-1)),t("div",lt,[s[20]||(s[20]=t("span",{class:"stay-label"},"入住",-1)),t("span",ct,n(S(e.checkInDate)),1)])]),s[25]||(s[25]=t("div",{class:"stay-separator"},[t("i",{class:"fas fa-arrow-right"})],-1)),t("div",dt,[s[23]||(s[23]=t("div",{class:"stay-icon"},[t("i",{class:"fas fa-calendar-times"})],-1)),t("div",rt,[s[22]||(s[22]=t("span",{class:"stay-label"},"退房",-1)),t("span",ut,n(S(e.checkOutDate)),1)])]),t("div",pt,[s[24]||(s[24]=t("i",{class:"fas fa-moon"},null,-1)),t("span",null,n(e.nights)+"晚",1)])])])])):r("",!0),e.type==="product"?(l(),i("div",vt,[(l(!0),i(b,null,N(e.items,c=>(l(),i("div",{key:c.id,class:"product-item"},[t("img",{src:c.image,alt:c.name,class:"product-image"},null,8,mt),t("div",ft,[t("h4",gt,n(c.name),1),t("p",_t,n(c.description),1),c.specs?(l(),i("div",yt,[(l(!0),i(b,null,N(c.specs.slice(0,2),P=>(l(),i("span",{key:P,class:"spec-tag"},n(P),1))),128))])):r("",!0)]),t("div",ht,[t("span",null,"x"+n(c.quantity),1)]),t("div",bt,[t("span",kt,"¥"+n((c.price*c.quantity).toFixed(2)),1)])]))),128)),t("div",wt,[t("div",At,[s[26]||(s[26]=t("span",{class:"label"},"收货地址：",-1)),t("span",Ct,n(e.shippingAddress),1)]),t("div",Dt,[s[27]||(s[27]=t("span",{class:"label"},"联系电话：",-1)),t("span",Nt,n(e.contactPhone),1)])])])):r("",!0),t("div",Ot,[t("div",It,[t("div",St,[t("div",Mt,[s[28]||(s[28]=t("span",{class:"price-label"},[t("i",{class:"fas fa-bed"}),m(" 房费 ")],-1)),t("span",Tt,"¥"+n(e.roomPrice)+" × "+n(e.nights)+"晚",1)]),s[31]||(s[31]=t("div",{class:"price-divider"},null,-1)),t("div",xt,[s[30]||(s[30]=t("span",{class:"price-label"},[t("i",{class:"fas fa-calculator"}),m(" 总计 ")],-1)),t("span",$t,[s[29]||(s[29]=t("span",{class:"currency"},"¥",-1)),t("span",qt,n(e.totalAmount),1)])])]),s[32]||(s[32]=t("div",{class:"price-decoration"},[t("div",{class:"price-glow"})],-1))])])]),t("div",Pt,[t("div",Vt,[e.status==="pending"?(l(),i("button",{key:0,onClick:O(c=>Z(e),["stop"]),class:"btn btn-outline btn-danger btn-animated"},s[33]||(s[33]=[t("i",{class:"fas fa-times"},null,-1),t("span",null,"取消订单",-1),t("div",{class:"btn-ripple"},null,-1)]),8,zt)):r("",!0),e.status==="confirmed"?(l(),i("button",{key:1,onClick:O(c=>M(e),["stop"]),class:"btn btn-outline btn-animated"},s[34]||(s[34]=[t("i",{class:"fas fa-eye"},null,-1),t("span",null,"查看详情",-1),t("div",{class:"btn-ripple"},null,-1)]),8,Bt)):r("",!0),e.status==="completed"?(l(),i("button",{key:2,onClick:O(c=>ss(e),["stop"]),class:"btn btn-primary btn-animated"},s[35]||(s[35]=[t("i",{class:"fas fa-star"},null,-1),t("span",null,"评价订单",-1),t("div",{class:"btn-ripple"},null,-1)]),8,Ft)):r("",!0),t("button",{onClick:O(c=>M(e),["stop"]),class:"btn btn-outline btn-animated"},s[36]||(s[36]=[t("i",{class:"fas fa-file-alt"},null,-1),t("span",null,"订单详情",-1),t("div",{class:"btn-ripple"},null,-1)]),8,jt)])])],8,Bs))),128))]))],64)):(l(),i("div",$s,[s[7]||(s[7]=t("div",{class:"prompt-animation"},[t("div",{class:"lock-icon"},[t("i",{class:"fas fa-user-lock"}),t("div",{class:"lock-pulse"})])],-1)),s[8]||(s[8]=t("h3",null,"请先登录",-1)),s[9]||(s[9]=t("p",null,"登录后即可查看您的订单信息",-1)),t("div",qs,[D(o,{to:"/login",class:"btn btn-primary btn-animated"},{default:x(()=>s[5]||(s[5]=[t("span",null,"立即登录",-1),t("div",{class:"btn-shine"},null,-1)])),_:1,__:[5]}),D(o,{to:"/register",class:"btn btn-outline btn-animated"},{default:x(()=>s[6]||(s[6]=[t("span",null,"注册账号",-1),t("div",{class:"btn-shine"},null,-1)])),_:1,__:[6]})])]))])])])])}}}),Ht=us(Et,[["__scopeId","data-v-7f3ca1c8"]]);export{Ht as default};
