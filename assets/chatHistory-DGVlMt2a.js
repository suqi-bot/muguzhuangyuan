import{X as L,a as U,b as g}from"./index-vYzfv9NW.js";const T=L("chatHistory",()=>{const r=U(),n=g([]),o=g(""),f=g(!1),c=()=>n.value.find(t=>t.id===o.value)||null,h=(t,e)=>{const s="session_"+Date.now()+"_"+Math.random().toString(36).substring(2,11),u={id:s,userId:t,sessionName:e||`AI选房会话 ${new Date().toLocaleString()}`,messages:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),context:{}};return n.value.unshift(u),o.value=s,a(),s},v=t=>{const e=c();if(!e)return;const s={...t,id:"msg_"+Date.now()+"_"+Math.random().toString(36).substring(2,11),timestamp:new Date().toLocaleTimeString()};e.messages.push(s),e.updatedAt=new Date().toISOString(),a()},p=t=>{const e=c();e&&(e.context={...e.context,...t},e.updatedAt=new Date().toISOString(),a())},I=t=>n.value.filter(e=>e.userId===t),w=t=>n.value.find(s=>s.id===t)?(o.value=t,console.log("🔄 切换到会话:",t),!0):!1,A=t=>{const e=n.value.findIndex(s=>s.id===t);e>-1&&(n.value.splice(e,1),o.value===t&&(o.value=""),a(),console.log("🗑️ 删除会话:",t))},D=()=>{n.value=[],o.value="",localStorage.removeItem("chat_history")},i=()=>`chat_history_${r.user?.id||r.user?.username||"guest"}`,a=()=>{if(r.isAuthenticated)try{const t={sessions:n.value,currentSessionId:o.value,userId:r.user?.id||r.user?.username};localStorage.setItem(i(),JSON.stringify(t))}catch{}},l=()=>{if(r.isAuthenticated)try{const t=localStorage.getItem(i());if(t){const e=JSON.parse(t),s=r.user?.id||r.user?.username;e.userId===s?(n.value=e.sessions||[],o.value=e.currentSessionId||""):(n.value=[],o.value="")}}catch{}},S=()=>{n.value=[],o.value="",r.isAuthenticated&&localStorage.removeItem(i())},y=()=>{l()},x=()=>{S()},M=t=>{const e=n.value.find(s=>s.id===t);return e?JSON.stringify(e,null,2):null},O=t=>{const e=n.value.find(s=>s.id===t);return e?{totalMessages:e.messages.length,userMessages:e.messages.filter(s=>s.type==="user").length,aiMessages:e.messages.filter(s=>s.type==="ai").length,roomRecommendations:e.messages.filter(s=>s.roomRecommendations&&s.roomRecommendations.length>0).length,orders:e.messages.filter(s=>s.orderInfo).length,duration:new Date(e.updatedAt).getTime()-new Date(e.createdAt).getTime()}:null},_=(t,e)=>{const s=e?n.value.filter(d=>d.id===e):n.value,u=[];return s.forEach(d=>{d.messages.forEach(m=>{m.content.toLowerCase().includes(t.toLowerCase())&&u.push(m)})}),u};return l(),{sessions:n,currentSessionId:o,isLoading:f,getCurrentSession:c,createSession:h,addMessage:v,updateSessionContext:p,getUserSessions:I,switchToSession:w,deleteSession:A,clearAllSessions:D,saveToStorage:a,loadFromStorage:l,exportSession:M,getSessionStats:O,searchMessages:_,clearUserData:S,initializeUserData:y,onUserLogout:x,getUserStorageKey:i}});export{T as useChatHistoryStore};
