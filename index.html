<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™®æ´±è˜‘è‡åº„å›­æ°‘å®¿</title>
    <script type="module" crossorigin src="/muguzhuangyuan/assets/index-PKPpSeMn.js"></script>
    <link rel="stylesheet" crossorigin href="/muguzhuangyuan/assets/index-Bcx-0840.css">
  </head>
  <body>
    <div id="app"></div>

    <!-- DifyèŠå¤©åŠ©æ‰‹é…ç½® -->
    <script>
      window.difyChatbotConfig = {
        token: 'fggmGdSFt6MSQFJa',
        baseUrl: 'http://4295a4ce.r28.cpolar.top'
      }
    </script>

    <!-- DifyèŠå¤©åŠ©æ‰‹è„šæœ¬ - å°è¯•ä¸åŒçš„è·¯å¾„ -->
    <script>
      // å°è¯•åŠ è½½Dify embedè„šæœ¬
      function loadDifyScript() {
        console.log('å¼€å§‹åŠ è½½Difyè„šæœ¬...');

        const script = document.createElement('script');
        script.id = 'fggmGdSFt6MSQFJa';
        script.defer = true;

        // å°è¯•ä¸åŒçš„å¯èƒ½è·¯å¾„
        const possibleUrls = [
          'http://47be5268.r28.cpolar.top/embed.min.js',
          'http://47be5268.r28.cpolar.top/static/embed.min.js',
          'http://47be5268.r28.cpolar.top/js/embed.min.js',
          'http://47be5268.r28.cpolar.top/assets/embed.min.js'
        ];

        let currentIndex = 0;

        function tryNextUrl() {
          if (currentIndex >= possibleUrls.length) {
            console.error('æ‰€æœ‰Difyè„šæœ¬URLéƒ½åŠ è½½å¤±è´¥');
            return;
          }

          const url = possibleUrls[currentIndex];
          console.log(`å°è¯•åŠ è½½: ${url}`);

          script.src = url;
          script.onload = function() {
            console.log(`Difyè„šæœ¬åŠ è½½æˆåŠŸ: ${url}`);
          };

          script.onerror = function() {
            console.error(`Difyè„šæœ¬åŠ è½½å¤±è´¥: ${url}`);
            currentIndex++;
            // ç§»é™¤å¤±è´¥çš„è„šæœ¬
            if (script.parentNode) {
              script.parentNode.removeChild(script);
            }
            // åˆ›å»ºæ–°çš„scriptå…ƒç´ å°è¯•ä¸‹ä¸€ä¸ªURL
            setTimeout(() => {
              const newScript = document.createElement('script');
              newScript.id = 'fggmGdSFt6MSQFJa';
              newScript.defer = true;
              Object.assign(script, newScript);
              tryNextUrl();
            }, 1000);
          };

          document.head.appendChild(script);
        }

        tryNextUrl();
      }

      // é¡µé¢åŠ è½½åç«‹å³å°è¯•åŠ è½½è„šæœ¬
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadDifyScript);
      } else {
        loadDifyScript();
      }
    </script>

    <!-- æµ‹è¯•DifyæœåŠ¡è¿æ¥å¹¶åˆ›å»ºè‡ªå®šä¹‰æŒ‰é’® -->
    <script>
      // æµ‹è¯•DifyæœåŠ¡æ˜¯å¦å¯ç”¨
      async function testDifyService() {
        console.log('æµ‹è¯•DifyæœåŠ¡è¿æ¥...');

        const testEndpoints = [
          {
            name: 'Difyæ ‡å‡†API',
            url: 'http://47be5268.r28.cpolar.top/v1/chat-messages',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer app-oaUwvb7k2zbC8Bi03EO977nN'
            },
            body: {
              inputs: {},
              query: 'æµ‹è¯•è¿æ¥',
              response_mode: 'blocking',
              conversation_id: '',
              user: 'test-user'
            }
          },
          {
            name: 'Difyç›´æ¥è°ƒç”¨',
            url: 'http://47be5268.r28.cpolar.top/chat/fggmGdSFt6MSQFJa',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: {
              message: 'æµ‹è¯•è¿æ¥',
              user: 'test-user'
            }
          }
        ];

        for (const endpoint of testEndpoints) {
          try {
            console.log(`æµ‹è¯• ${endpoint.name}...`);
            const response = await fetch(endpoint.url, {
              method: endpoint.method,
              mode: 'cors',
              headers: endpoint.headers,
              body: JSON.stringify(endpoint.body)
            });

            console.log(`${endpoint.name} å“åº”çŠ¶æ€:`, response.status);

            if (response.ok) {
              const data = await response.json();
              console.log(`${endpoint.name} æµ‹è¯•æˆåŠŸ:`, data);
              return true;
            } else {
              console.log(`${endpoint.name} å“åº”å¤±è´¥:`, response.status, response.statusText);
            }
          } catch (error) {
            console.error(`${endpoint.name} æµ‹è¯•å¤±è´¥:`, error);
          }
        }

        console.log('æ‰€æœ‰Difyç«¯ç‚¹æµ‹è¯•éƒ½å¤±è´¥');
        return false;
      }

      // åˆ›å»ºè‡ªå®šä¹‰Difyé£æ ¼çš„AIæŒ‰é’®
      function createCustomDifyButton() {
        console.log('åˆ›å»ºè‡ªå®šä¹‰Difyé£æ ¼AIæŒ‰é’®...');

        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æŒ‰é’®
        const existingButton = document.getElementById('dify-chatbot-bubble-button');
        if (existingButton) {
          existingButton.remove();
        }

        // åˆ›å»ºæŒ‰é’®
        const button = document.createElement('div');
        button.id = 'dify-chatbot-bubble-button';
        button.style.cssText = `
          position: fixed;
          bottom: 30px;
          right: 30px;
          width: 120px;
          height: 120px;
          background-image: url('/images/ai.png');
          background-size: contain;
          background-position: center;
          background-repeat: no-repeat;
          background-color: transparent;
          border: none;
          border-radius: 0;
          box-shadow: none;
          cursor: pointer;
          z-index: 999999;
          display: block;
          visibility: visible;
          opacity: 1;
          pointer-events: auto;
          transform: none;
          margin: 0;
          padding: 0;
          animation: aiFloat 3s ease-in-out infinite;
          transition: all 0.3s ease;
        `;

        // æ·»åŠ æ‚¬åœæ•ˆæœ - æ— é˜´å½±
        button.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.05)';
          this.style.filter = 'brightness(1.1)';
        });

        button.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1)';
          this.style.filter = 'brightness(1)';
        });

        // ç‚¹å‡»äº‹ä»¶ - æ‰“å¼€DifyèŠå¤©çª—å£
        button.addEventListener('click', function() {
          createDifyChatWindow();
        });

        document.body.appendChild(button);
        console.log('è‡ªå®šä¹‰Difyé£æ ¼AIæŒ‰é’®å·²åˆ›å»º');
      }

      // åˆ›å»ºDifyé£æ ¼çš„èŠå¤©çª—å£
      function createDifyChatWindow() {
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§çª—å£
        const existingWindow = document.getElementById('dify-chatbot-bubble-window');
        if (existingWindow) {
          existingWindow.remove();
          return;
        }

        const chatWindow = document.createElement('div');
        chatWindow.id = 'dify-chatbot-bubble-window';
        chatWindow.innerHTML = `
          <div style="
            position: fixed;
            bottom: 170px;
            right: 30px;
            width: 20rem;
            height: 32rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 12px 24px rgba(139, 69, 19, 0.15);
            border: 2px solid rgba(160, 82, 45, 0.2);
            z-index: 999998;
            display: flex;
            flex-direction: column;
          ">
            <div style="
              background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
              color: white;
              padding: 15px;
              border-radius: 14px 14px 0 0;
              display: flex;
              justify-content: space-between;
              align-items: center;
            ">
              <div style="display: flex; align-items: center; gap: 10px;">
                <img src="/images/ai.png" style="width: 32px; height: 32px; border-radius: 50%;" />
                <span style="font-weight: 600;">æ™®æ™®1.0 - AIåŠ©æ‰‹</span>
              </div>
              <button onclick="document.getElementById('dify-chatbot-bubble-window').remove()" style="
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                font-size: 18px;
                padding: 5px;
              ">Ã—</button>
            </div>
            <div style="
              flex: 1;
              padding: 15px;
              overflow-y: auto;
              background: linear-gradient(135deg, #faf8f1 0%, #f4f1de 100%);
            ">
              <div style="
                background: linear-gradient(135deg, #f4f1de 0%, #e9c46a 100%);
                color: #8b4513;
                padding: 10px 15px;
                border-radius: 12px 12px 12px 4px;
                margin-bottom: 10px;
                border: 1px solid rgba(160, 82, 45, 0.2);
              ">
                æ‚¨å¥½ï¼æˆ‘æ˜¯æ™®æ™®1.0ï¼Œæ™®æ´±è˜‘è‡åº„å›­æ°‘å®¿çš„AIåŠ©æ‰‹ã€‚å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼<br><br>
                <strong>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</strong><br>
                â€¢ äº†è§£æˆ¿é—´ä¿¡æ¯å’Œé¢„è®¢<br>
                â€¢ ä»‹ç»å½“åœ°æ™¯ç‚¹å’Œæ´»åŠ¨<br>
                â€¢ æ™®æ´±èŒ¶æ–‡åŒ–çŸ¥è¯†<br>
                â€¢ è˜‘è‡åº„å›­ç‰¹è‰²ä½“éªŒ<br><br>
                è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
              </div>
            </div>
            <div style="
              padding: 15px;
              border-top: 1px solid rgba(160, 82, 45, 0.2);
              background: rgba(139, 69, 19, 0.05);
              border-radius: 0 0 14px 14px;
            ">
              <!-- è¯­éŸ³å¯¹è¯æŒ‰é’® -->
              <div style="display: flex; justify-content: center; margin-bottom: 10px;">
                <button id="voice-call-btn" onclick="toggleVoiceCall()" style="
                  background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
                  color: white;
                  border: none;
                  padding: 8px 16px;
                  border-radius: 20px;
                  cursor: pointer;
                  font-weight: 600;
                  font-size: 12px;
                ">ğŸ¤ å¼€å§‹è¯­éŸ³å¯¹è¯</button>
              </div>
              <!-- è¾“å…¥åŒºåŸŸ -->
              <div style="display: flex; gap: 8px; align-items: center;">
                <input id="dify-chat-input" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." style="
                  flex: 1;
                  padding: 8px 12px;
                  border: 2px solid rgba(160, 82, 45, 0.3);
                  border-radius: 20px;
                  outline: none;
                  background: linear-gradient(135deg, rgba(244, 241, 222, 0.9) 0%, rgba(250, 248, 241, 0.9) 100%);
                  color: #8b4513;
                  font-size: 14px;
                " />
                <button id="voice-input-btn" onclick="toggleVoiceInput()" style="
                  background: linear-gradient(135deg, #FF6347 0%, #FF4500 100%);
                  color: white;
                  border: none;
                  padding: 8px 12px;
                  border-radius: 50%;
                  cursor: pointer;
                  font-size: 14px;
                  width: 36px;
                  height: 36px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                ">ğŸ¤</button>
                <button onclick="sendDifyMessage()" style="
                  background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
                  color: white;
                  border: none;
                  padding: 8px 16px;
                  border-radius: 20px;
                  cursor: pointer;
                  font-weight: 600;
                  font-size: 14px;
                ">å‘é€</button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(chatWindow);

        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('dify-chat-input');
          if (input) input.focus();
        }, 100);
      }

      // è¯­éŸ³è¯†åˆ«ç›¸å…³å˜é‡
      let recognition = null;
      let isListening = false;
      let isVoiceCallActive = false;

      // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
      function initSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'zh-CN';

          recognition.onstart = function() {
            console.log('è¯­éŸ³è¯†åˆ«å¼€å§‹');
            isListening = true;
            updateVoiceInputButton();
          };

          recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            console.log('è¯†åˆ«ç»“æœ:', transcript);
            document.getElementById('dify-chat-input').value = transcript;

            // å¦‚æœæ˜¯è¯­éŸ³å¯¹è¯æ¨¡å¼ï¼Œè‡ªåŠ¨å‘é€æ¶ˆæ¯
            if (isVoiceCallActive) {
              sendDifyMessage();
            }
          };

          recognition.onerror = function(event) {
            console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
            isListening = false;
            updateVoiceInputButton();
          };

          recognition.onend = function() {
            console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');
            isListening = false;
            updateVoiceInputButton();
          };
        } else {
          console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
        }
      }

      // åˆ‡æ¢è¯­éŸ³è¾“å…¥
      function toggleVoiceInput() {
        if (!recognition) {
          alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
          return;
        }

        if (isListening) {
          recognition.stop();
        } else {
          recognition.start();
        }
      }

      // æ›´æ–°è¯­éŸ³è¾“å…¥æŒ‰é’®çŠ¶æ€
      function updateVoiceInputButton() {
        const btn = document.getElementById('voice-input-btn');
        if (btn) {
          if (isListening) {
            btn.innerHTML = 'ğŸ”´';
            btn.style.background = 'linear-gradient(135deg, #DC143C 0%, #B22222 100%)';
          } else {
            btn.innerHTML = 'ğŸ¤';
            btn.style.background = 'linear-gradient(135deg, #FF6347 0%, #FF4500 100%)';
          }
        }
      }

      // åˆ‡æ¢è¯­éŸ³å¯¹è¯æ¨¡å¼
      function toggleVoiceCall() {
        const btn = document.getElementById('voice-call-btn');
        if (!btn) return;

        if (!recognition) {
          alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
          return;
        }

        isVoiceCallActive = !isVoiceCallActive;

        if (isVoiceCallActive) {
          btn.innerHTML = 'ğŸ”´ ç»“æŸè¯­éŸ³å¯¹è¯';
          btn.style.background = 'linear-gradient(135deg, #DC143C 0%, #B22222 100%)';
          addMessageToChat('è¯­éŸ³å¯¹è¯æ¨¡å¼å·²å¼€å¯ï¼Œè¯·è¯´è¯...', 'system');
        } else {
          btn.innerHTML = 'ğŸ¤ å¼€å§‹è¯­éŸ³å¯¹è¯';
          btn.style.background = 'linear-gradient(135deg, #228B22 0%, #32CD32 100%)';
          addMessageToChat('è¯­éŸ³å¯¹è¯æ¨¡å¼å·²å…³é—­', 'system');
          if (isListening) {
            recognition.stop();
          }
        }
      }

      // æ–‡æœ¬è½¬è¯­éŸ³
      function speakText(text) {
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'zh-CN';
          utterance.rate = 0.9;
          utterance.pitch = 1.1;
          speechSynthesis.speak(utterance);
        }
      }

      // å‘é€æ¶ˆæ¯åˆ°Dify API
      async function sendDifyMessage() {
        const input = document.getElementById('dify-chat-input');
        if (!input) return;

        const message = input.value.trim();
        if (!message) return;

        console.log('å‘é€æ¶ˆæ¯åˆ°Dify API:', message);

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        addMessageToChat(message, 'user');

        try {
          console.log('å¼€å§‹APIè°ƒç”¨...');
          console.log('ç”¨æˆ·æ¶ˆæ¯:', message);

          // é¦–å…ˆå°è¯•JSONPæ–¹å¼ï¼ˆå¦‚æœæ”¯æŒï¼‰
          try {
            console.log('å°è¯•JSONPè°ƒç”¨...');
            const jsonpResult = await tryJSONPCall(message);
            if (jsonpResult && (jsonpResult.answer || jsonpResult.message)) {
              const aiResponse = jsonpResult.answer || jsonpResult.message;
              addMessageToChat(aiResponse, 'ai');

              if (isVoiceCallActive) {
                speakText(aiResponse);
                setTimeout(() => {
                  if (isVoiceCallActive && recognition) {
                    recognition.start();
                  }
                }, 2000);
              }

              input.value = '';
              return;
            }
          } catch (jsonpError) {
            console.log('JSONPè°ƒç”¨å¤±è´¥ï¼Œå°è¯•æ ‡å‡†API:', jsonpError.message);
          }

          // åªä½¿ç”¨Dify APIè°ƒç”¨æ–¹å¼
          const apiMethods = [
            // æ–¹æ³•1: Difyæ ‡å‡†API
            {
              name: 'Difyæ ‡å‡†API',
              url: 'http://47be5268.r28.cpolar.top/v1/chat-messages',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer app-oaUwvb7k2zbC8Bi03EO977nN'
              },
              body: {
                inputs: {},
                query: message,
                response_mode: 'blocking',
                conversation_id: '',
                user: 'user-' + Date.now()
              }
            },
            // æ–¹æ³•2: Difyç›´æ¥è°ƒç”¨
            {
              name: 'Difyç›´æ¥è°ƒç”¨',
              url: 'http://47be5268.r28.cpolar.top/chat/fggmGdSFt6MSQFJa',
              headers: {
                'Content-Type': 'application/json'
              },
              body: {
                message: message,
                user: 'user-' + Date.now()
              }
            }
          ];

          let lastError = null;
          let success = false;

          for (let i = 0; i < apiMethods.length; i++) {
            const method = apiMethods[i];
            console.log(`å°è¯•æ–¹æ³• ${i + 1}: ${method.name}`);

            try {
              console.log(`è°ƒç”¨ ${method.name}:`, {
                url: method.url,
                headers: method.headers,
                body: method.body
              });

              const response = await fetch(method.url, {
                method: 'POST',
                mode: 'cors',
                headers: {
                  ...method.headers,
                  'Accept': 'application/json'
                },
                body: JSON.stringify(method.body)
              });

              console.log(`${method.name} å“åº”çŠ¶æ€:`, response.status);
              console.log(`${method.name} å“åº”å¤´:`, Object.fromEntries(response.headers.entries()));

              if (response.ok) {
                const contentType = response.headers.get('content-type');
                console.log(`${method.name} å†…å®¹ç±»å‹:`, contentType);

                let data;
                if (contentType && contentType.includes('application/json')) {
                  data = await response.json();
                } else {
                  const text = await response.text();
                  console.log(`${method.name} æ–‡æœ¬å“åº”:`, text);
                  try {
                    data = JSON.parse(text);
                  } catch (e) {
                    throw new Error(`å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSON: ${text}`);
                  }
                }

                console.log(`${method.name} å“åº”æ•°æ®:`, data);

                let aiResponse = '';
                if (data.answer) {
                  aiResponse = data.answer;
                } else if (data.message) {
                  aiResponse = data.message;
                } else if (data.response) {
                  aiResponse = data.response;
                } else if (data.data && data.data.answer) {
                  aiResponse = data.data.answer;
                } else {
                  aiResponse = 'æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼ŒAIæ­£åœ¨æ€è€ƒä¸­...';
                }

                addMessageToChat(aiResponse, 'ai');

                // å¦‚æœæ˜¯è¯­éŸ³å¯¹è¯æ¨¡å¼ï¼Œæ’­æ”¾AIå›å¤
                if (isVoiceCallActive) {
                  speakText(aiResponse);
                  // æ’­æ”¾å®Œæˆåè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®è¯­éŸ³è¯†åˆ«
                  setTimeout(() => {
                    if (isVoiceCallActive && recognition) {
                      recognition.start();
                    }
                  }, 2000);
                }

                success = true;
                break;
              } else {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
              }
            } catch (error) {
              console.error(`${method.name} è°ƒç”¨å¤±è´¥:`, error);
              console.error(`é”™è¯¯è¯¦æƒ…:`, {
                message: error.message,
                stack: error.stack,
                url: method.url
              });
              lastError = error;
              continue;
            }
          }

          if (!success) {
            // æœ€åå°è¯•ï¼šä½¿ç”¨iframeæ–¹å¼
            console.log('å°è¯•iframeæ–¹å¼è°ƒç”¨...');
            try {
              const iframeResult = await tryIframeCall(message);
              if (iframeResult) {
                addMessageToChat(iframeResult, 'ai');

                if (isVoiceCallActive) {
                  speakText(iframeResult);
                  setTimeout(() => {
                    if (isVoiceCallActive && recognition) {
                      recognition.start();
                    }
                  }, 2000);
                }

                success = true;
              }
            } catch (iframeError) {
              console.error('iframeè°ƒç”¨ä¹Ÿå¤±è´¥:', iframeError);
            }
          }

          if (!success) {
            throw lastError || new Error('æ‰€æœ‰APIè°ƒç”¨æ–¹æ³•éƒ½å¤±è´¥äº†');
          }

        } catch (error) {
          console.error('æ‰€æœ‰Dify APIè°ƒç”¨éƒ½å¤±è´¥:', error);

          // æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
          console.log('=== Dify APIè°ƒç”¨å¤±è´¥è¯¦ç»†ä¿¡æ¯ ===');
          console.log('é”™è¯¯å¯¹è±¡:', error);
          console.log('é”™è¯¯æ¶ˆæ¯:', error.message);
          console.log('é”™è¯¯å †æ ˆ:', error.stack);
          console.log('å°è¯•çš„APIç«¯ç‚¹:');
          console.log('1. http://47be5268.r28.cpolar.top/v1/chat-messages');
          console.log('2. http://47be5268.r28.cpolar.top/chat/fggmGdSFt6MSQFJa');
          console.log('ä½¿ç”¨çš„å¯†é’¥: app-oaUwvb7k2zbC8Bi03EO977nN');
          console.log('================================');

          // æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œä¸´æ—¶è§£å†³æ–¹æ¡ˆ
          let errorMessage = 'ğŸ¤– æ™®æ™®1.0 æš‚æ—¶æ— æ³•è¿æ¥åˆ°DifyæœåŠ¡å™¨\\n\\n';

          if (error.message.includes('Failed to fetch')) {
            errorMessage += 'ğŸ“‹ è°ƒè¯•ä¿¡æ¯ï¼š\\n';
            errorMessage += 'â€¢ é”™è¯¯ç±»å‹: ç½‘ç»œè¯·æ±‚å¤±è´¥\\n';
            errorMessage += 'â€¢ å¯èƒ½åŸå› : CORSè·¨åŸŸé™åˆ¶\\n';
            errorMessage += 'â€¢ æœåŠ¡å™¨: http://47be5268.r28.cpolar.top\\n';
            errorMessage += 'â€¢ APIå¯†é’¥: app-oaUwvb7k2zbC8Bi03EO977nN\\n\\n';

            errorMessage += 'ğŸ”§ æŠ€æœ¯è§£å†³æ–¹æ¡ˆï¼š\\n';
            errorMessage += '1. æœåŠ¡å™¨ç«¯æ·»åŠ CORSå¤´ï¼š\\n';
            errorMessage += '   Access-Control-Allow-Origin: *\\n';
            errorMessage += '   Access-Control-Allow-Methods: POST\\n';
            errorMessage += '   Access-Control-Allow-Headers: Content-Type, Authorization\\n\\n';

            errorMessage += '2. æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†\\n';
            errorMessage += '3. æˆ–é…ç½®æµè§ˆå™¨ç¦ç”¨CORSæ£€æŸ¥\\n\\n';

            // æä¾›æ¨¡æ‹Ÿå“åº”
            errorMessage += 'ğŸ’¡ ä¸´æ—¶æ¼”ç¤ºæ¨¡å¼ï¼š\\n';
            errorMessage += 'æˆ‘ç°åœ¨ä»¥æ¼”ç¤ºæ¨¡å¼è¿è¡Œã€‚çœŸå®çš„AIåŠŸèƒ½éœ€è¦è§£å†³CORSé—®é¢˜åæ‰èƒ½ä½¿ç”¨ã€‚\\n\\n';
            errorMessage += 'æ‚¨çš„é—®é¢˜æ˜¯: "' + message + '"\\n\\n';
            errorMessage += 'ğŸ¨ å…³äºæ™®æ´±è˜‘è‡åº„å›­æ°‘å®¿ï¼š\\n';
            errorMessage += 'â€¢ æˆ‘ä»¬æä¾›èˆ’é€‚çš„ä½å®¿ç¯å¢ƒ\\n';
            errorMessage += 'â€¢ å¯ä»¥ä½“éªŒæ™®æ´±èŒ¶æ–‡åŒ–\\n';
            errorMessage += 'â€¢ äº«å—è˜‘è‡åº„å›­çš„è‡ªç„¶é£å…‰\\n';
            errorMessage += 'â€¢ æœ‰å¤šç§æˆ¿å‹å¯ä¾›é€‰æ‹©\\n\\n';
            errorMessage += 'å¦‚éœ€çœŸå®AIå¯¹è¯ï¼Œè¯·è”ç³»æŠ€æœ¯äººå‘˜è§£å†³CORSé…ç½®é—®é¢˜ã€‚';
          } else {
            errorMessage += `âŒ é”™è¯¯è¯¦æƒ…ï¼š${error.message}\\n\\n`;
            errorMessage += 'è¯·è”ç³»æŠ€æœ¯æ”¯æŒè§£å†³æ­¤é—®é¢˜ã€‚';
          }

          addMessageToChat(errorMessage, 'ai');
        }

        input.value = '';
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
      function addMessageToChat(message, type) {
        const chatContainer = document.querySelector('#dify-chatbot-bubble-window > div > div:nth-child(2)');
        if (!chatContainer) return;

        const messageDiv = document.createElement('div');

        if (type === 'user') {
          messageDiv.style.cssText = `
            background: linear-gradient(135deg, #d2b48c 0%, #daa520 100%);
            color: #8b4513;
            padding: 8px 12px;
            border-radius: 12px 12px 4px 12px;
            margin: 8px 0 8px 20%;
            border: 1px solid rgba(218, 165, 32, 0.3);
            text-align: right;
            font-size: 14px;
            line-height: 1.4;
          `;
        } else if (type === 'system') {
          messageDiv.style.cssText = `
            background: linear-gradient(135deg, #e6e6fa 0%, #d8bfd8 100%);
            color: #663399;
            padding: 6px 10px;
            border-radius: 8px;
            margin: 6px 10%;
            border: 1px solid rgba(102, 51, 153, 0.2);
            text-align: center;
            font-size: 12px;
            font-style: italic;
          `;
        } else {
          messageDiv.style.cssText = `
            background: linear-gradient(135deg, #f4f1de 0%, #e9c46a 100%);
            color: #8b4513;
            padding: 8px 12px;
            border-radius: 12px 12px 12px 4px;
            margin: 8px 20% 8px 0;
            border: 1px solid rgba(160, 82, 45, 0.2);
            font-size: 14px;
            line-height: 1.4;
          `;
        }

        // å¤„ç†æ¢è¡Œç¬¦
        messageDiv.innerHTML = message.replace(/\\n/g, '<br>');
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // ç®€å•çš„ç½‘ç»œè¿é€šæ€§æµ‹è¯•
      async function testNetworkConnectivity() {
        console.log('æµ‹è¯•ç½‘ç»œè¿é€šæ€§...');

        try {
          // æµ‹è¯•åŸºæœ¬çš„ç½‘ç»œè¿æ¥
          const response = await fetch('http://47be5268.r28.cpolar.top', {
            method: 'GET',
            mode: 'no-cors' // é¿å…CORSï¼Œåªæµ‹è¯•è¿é€šæ€§
          });
          console.log('ç½‘ç»œè¿é€šæ€§æµ‹è¯•å®Œæˆ');
          return true;
        } catch (error) {
          console.error('ç½‘ç»œè¿é€šæ€§æµ‹è¯•å¤±è´¥:', error);
          return false;
        }
      }

      // å°è¯•ä½¿ç”¨iframeæ–¹å¼è°ƒç”¨
      function tryIframeCall(message) {
        return new Promise((resolve, reject) => {
          console.log('åˆ›å»ºiframeè¿›è¡ŒAPIè°ƒç”¨...');

          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = 'about:blank';

          iframe.onload = function() {
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

              // åˆ›å»ºè¡¨å•è¿›è¡ŒPOSTè¯·æ±‚
              const form = iframeDoc.createElement('form');
              form.method = 'POST';
              form.action = 'http://47be5268.r28.cpolar.top/v1/chat-messages';

              // æ·»åŠ è¡¨å•å­—æ®µ
              const fields = {
                'query': message,
                'response_mode': 'blocking',
                'user': 'user-' + Date.now()
              };

              for (const [key, value] of Object.entries(fields)) {
                const input = iframeDoc.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
              }

              iframeDoc.body.appendChild(form);
              form.submit();

              // ç›‘å¬å“åº”ï¼ˆè¿™ç§æ–¹æ³•æœ‰é™åˆ¶ï¼‰
              setTimeout(() => {
                document.body.removeChild(iframe);
                resolve('iframeè°ƒç”¨å·²å‘é€ï¼Œä½†æ— æ³•è·å–å“åº”ï¼ˆCORSé™åˆ¶ï¼‰');
              }, 3000);

            } catch (error) {
              console.error('iframeè°ƒç”¨é”™è¯¯:', error);
              document.body.removeChild(iframe);
              reject(error);
            }
          };

          iframe.onerror = function() {
            console.error('iframeåŠ è½½å¤±è´¥');
            document.body.removeChild(iframe);
            reject(new Error('iframeåŠ è½½å¤±è´¥'));
          };

          document.body.appendChild(iframe);

          // 10ç§’è¶…æ—¶
          setTimeout(() => {
            if (iframe.parentNode) {
              document.body.removeChild(iframe);
              reject(new Error('iframeè°ƒç”¨è¶…æ—¶'));
            }
          }, 10000);
        });
      }

      // å°è¯•ä½¿ç”¨JSONPæ–¹å¼è°ƒç”¨ï¼ˆå¦‚æœæ”¯æŒï¼‰
      function tryJSONPCall(message) {
        return new Promise((resolve, reject) => {
          console.log('å°è¯•JSONPè°ƒç”¨...');

          const script = document.createElement('script');
          const callbackName = 'difyCallback' + Date.now();

          window[callbackName] = function(data) {
            console.log('JSONPå“åº”:', data);
            document.head.removeChild(script);
            delete window[callbackName];
            resolve(data);
          };

          script.onerror = function() {
            console.error('JSONPè°ƒç”¨å¤±è´¥');
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error('JSONPè°ƒç”¨å¤±è´¥'));
          };

          script.src = \`http://47be5268.r28.cpolar.top/chat/fggmGdSFt6MSQFJa?callback=\${callbackName}&message=\${encodeURIComponent(message)}\`;
          document.head.appendChild(script);

          // 5ç§’è¶…æ—¶
          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error('JSONPè°ƒç”¨è¶…æ—¶'));
            }
          }, 5000);
        });
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.addEventListener('load', async function() {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–Dify AIåŠ©æ‰‹...');

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        initSpeechRecognition();

        // æµ‹è¯•ç½‘ç»œè¿é€šæ€§
        const networkOk = await testNetworkConnectivity();
        console.log('ç½‘ç»œè¿é€šæ€§:', networkOk ? 'æ­£å¸¸' : 'å¼‚å¸¸');

        // æµ‹è¯•æœåŠ¡è¿æ¥
        const serviceOk = await testDifyService();
        console.log('DifyæœåŠ¡è¿æ¥:', serviceOk ? 'æ­£å¸¸' : 'å¼‚å¸¸');

        // ç­‰å¾…ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰å®˜æ–¹DifyæŒ‰é’®åŠ è½½
        setTimeout(() => {
          const officialButton = document.getElementById('dify-chatbot-bubble-button');
          if (!officialButton) {
            console.log('æœªæ‰¾åˆ°å®˜æ–¹DifyæŒ‰é’®ï¼Œåˆ›å»ºè‡ªå®šä¹‰æŒ‰é’®...');
            createCustomDifyButton();
          } else {
            console.log('æ‰¾åˆ°å®˜æ–¹DifyæŒ‰é’®ï¼Œè¿›è¡Œè‡ªå®šä¹‰...');
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®˜æ–¹æŒ‰é’®çš„è‡ªå®šä¹‰é€»è¾‘
          }
        }, 3000);
      });
    </script>

    <style>
      /* DifyèŠå¤©åŠ©æ‰‹è‡ªå®šä¹‰æ ·å¼ - åˆ é™¤è“è‰²èƒŒæ™¯ */
      #dify-chatbot-bubble-button {
        background-color: transparent !important;
        background-image: url('/muguzhuangyuan/images/ai.png') !important;
        background-size: contain !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        width: 120px !important;
        height: 120px !important;
        border: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        animation: aiFloat 3s ease-in-out infinite !important;
      }

      /* éšè—é»˜è®¤å›¾æ ‡ */
      #dify-chatbot-bubble-button svg {
        display: none !important;
      }

      /* èŠå¤©çª—å£æ ·å¼ - ç¼©å°å°ºå¯¸ */
      #dify-chatbot-bubble-window {
        width: 20rem !important;
        height: 32rem !important;
        border-radius: 16px !important;
        box-shadow: 0 12px 24px rgba(139, 69, 19, 0.15) !important;
        border: 2px solid rgba(160, 82, 45, 0.2) !important;
        position: fixed !important;
        bottom: 170px !important;
        right: 30px !important;
      }

      /* AIæµ®åŠ¨åŠ¨ç”» */
      @keyframes aiFloat {
        0%, 100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-5px);
        }
      }
    </style>
  </body>
</html>
